<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arab Alifbosi â€” Kartochkalar + Ovoz</title>
<style>
:root{
  --bg:#f4f8ff; --panel:#eaf2ff; --card:#ffffff; --ink:#16324a;
  --accent:#ffd166; --btn:#0aa2ff; --btn-ink:#fff; --card-h:180px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Noto Kufi Arabic",Arial,sans-serif;background:var(--bg);color:var(--ink)}
.topbar{ text-align:center; padding:18px 12px; background:var(--panel); border-bottom:1px solid #dbe7ff; }
.topbar h1{margin:0 0 6px; font-size:clamp(18px, 3vw, 28px)}
.hint{margin:6px 0 0; color:#325c84; font-weight:600}

/* Toolbar */
.toolbar{max-width:1100px;margin:10px auto 0;padding:0 16px;display:flex;gap:12px;justify-content:space-between;align-items:center;flex-wrap:wrap}
.left,.right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
select{padding:8px 10px;border-radius:12px;border:1px solid #cfe3ff;background:#fff}
.btn{background:var(--btn);color:var(--btn-ink);border:none;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700;box-shadow:0 6px 16px rgba(10,162,255,.25)}
.btn.secondary{background:#e9f4ff;color:#0a3760;box-shadow:none;border:1px solid #cfe3ff}
.btn.warn{background:#ffd166;color:#4a2a00;box-shadow:0 6px 16px rgba(255,209,102,.25)}
.btn:active{transform:translateY(1px)}

/* ğŸŸ¦ KATTAROQ REJIM/MAVZU SELECTLAR */
.big-select{font-size:18px;padding:12px 14px;border-radius:14px}
.label-big{font-size:16px;font-weight:800}

/* Grid RTL */
.grid{--min:130px;display:grid;gap:18px;padding:18px;margin:0 auto 28px;grid-template-columns:repeat(auto-fill,minmax(var(--min),1fr));max-width:1100px;direction:rtl}
.card,.card *{direction:ltr}
.placeholder{height:var(--card-h);border-radius:18px;visibility:hidden}

/* Cards */
.card{perspective:1000px;height:var(--card-h)}
.card-btn{position:relative;width:100%;height:100%;border:0;background:transparent;padding:0;cursor:pointer}
.inner{position:absolute;inset:0;border-radius:18px;background:var(--card);box-shadow:0 12px 32px rgba(0,0,0,.08);transition:transform .5s cubic-bezier(.2,.7,.2,1),box-shadow .2s;transform-style:preserve-3d;border:1px solid #dfe8f5}
.card-btn:hover .inner{box-shadow:0 14px 40px rgba(0,0,0,.12)}
.card.is-open .inner{transform:rotateY(180deg)}
.face{position:absolute;inset:0;backface-visibility:hidden;border-radius:18px;display:flex;align-items:center;justify-content:center;padding:14px}
.front{background:radial-gradient(circle at 30% -10%,#eaf3ff,#eaf3ff 30%,#fff 30%)}
.letter,.word{font-family:"Noto Kufi Arabic","Amiri",serif;font-size:clamp(34px,7.6vw,48px);line-height:1.1;color:#0a2450;text-shadow:0 2px 0 #fff,0 10px 24px rgba(10,36,80,.18);text-align:center}
.back{transform:rotateY(180deg);background:linear-gradient(135deg,#fff7e6,#fff),radial-gradient(120px 80px at 100% 0%,#ffe39b,transparent 70%),radial-gradient(100px 60px at 0% 100%,#cfe9ff,transparent 70%)}
.info{text-align:center}
.info .big{font-family:"Noto Kufi Arabic","Amiri",serif;margin:0 0 6px;direction:rtl;font-size:40px}
.info .name{margin:2px 0 10px;font-weight:800;color:#274a70;font-size:20px}

/* rangli front */
.card:nth-child(6n+1) .front{background:radial-gradient(circle at 30% -10%,#e3f7ff,#e3f7ff 30%,#fff 30%)}
.card:nth-child(6n+2) .front{background:radial-gradient(circle at 70% -10%,#ffe9f3,#ffe9f3 30%,#fff 30%)}
.card:nth-child(6n+3) .front{background:radial-gradient(circle at 20% -10%,#fff3d9,#fff3d9 30%,#fff 30%)}
.card:nth-child(6n+4) .front{background:radial-gradient(circle at 70% -10%,#ecffe9,#ecffe9 30%,#fff 30%)}
.card:nth-child(6n+5) .front{background:radial-gradient(circle at 30% -10%,#f1e9ff,#f1e9ff 30%,#fff 30%)}
.card:nth-child(6n+6) .front{background:radial-gradient(circle at 70% -10%,#ffe9e9,#ffe9e9 30%,#fff 30%)}

/* Overlay + nav + TTS bar */
.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,15,31,0);backdrop-filter:blur(0px) scale(1);z-index:50;padding:18px;direction:rtl;opacity:0;pointer-events:none;transition:background .35s ease,backdrop-filter .35s ease,opacity .35s ease}
.overlay.open{background:rgba(2,15,31,.55);backdrop-filter:blur(3px) scale(1.02);opacity:1;pointer-events:auto}
.ov-close{position:absolute;left:14px;top:12px;z-index:60;border:none;background:var(--accent);color:#4a2a00;width:38px;height:38px;border-radius:50%;cursor:pointer;font-size:24px;font-weight:900;box-shadow:0 8px 22px rgba(0,0,0,.25)}
.nav{position:absolute;inset-inline:16px;top:50%;transform:translateY(-50%);display:flex;justify-content:space-between;pointer-events:none}
.nav button{pointer-events:auto;width:44px;height:44px;border-radius:50%;border:none;background:#ffffffcc;color:#0a2b52;font-size:22px;cursor:pointer;box-shadow:0 10px 22px rgba(0,0,0,.2)}
.ttsbar{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:60}

.card.is-large{width:min(92vw,460px);height:min(80vh,520px)}
.card.pop-in{transform:scale(.7) translateY(30px);opacity:0;animation:popIn .45s cubic-bezier(.25,.8,.25,1) forwards}
.card.pop-out{transform:scale(1) translateY(0);opacity:1;animation:popOut .35s cubic-bezier(.4,0,.2,1) forwards}
@keyframes popIn{0%{transform:scale(.7) translateY(30px);opacity:0}60%{transform:scale(1.05) translateY(-6px);opacity:1}100%{transform:scale(1) translateY(0);opacity:1}}
@keyframes popOut{0%{transform:scale(1) translateY(0);opacity:1}100%{transform:scale(.7) translateY(40px);opacity:0}}

.card.is-large .letter{font-size:clamp(72px,14vw,110px)}
.card.is-large .info .big{font-size:clamp(48px,8vw,80px)}
.card.is-large .info .name{font-size:clamp(22px,3.6vw,32px)}

/* Dark */
.dark{--bg:#0e1726;--panel:#0b1423;--card:#101a2b;--ink:#dbe8ff;--btn:#3aaefc;--btn-ink:#05233b}
.dark .topbar{border-bottom-color:#10213a}
.dark .inner{border-color:#1a2a44;box-shadow:0 8px 24px rgba(0,0,0,.5)}
.dark .front{background:radial-gradient(circle at 30% -10%,#152338,#152338 30%,#0f1b2d 30%)}
.dark .ov-close{background:#ffc95b}
.dark .btn.secondary{background:#0f2139;color:#dbe8ff;border-color:#1d3b63}
</style>
</head>
<body>
  <header class="topbar">
    <h1>Arab Alifbosi â€” Kartochkalar</h1>
    <p class="hint">Kartochkaga bosing â€” kattalashadi va oâ€˜qilishi koâ€˜rinadi</p>
  </header>

  <div class="toolbar">
    <div class="left">
      <span class="label-big">Rejim:</span>
      <select id="mode" class="big-select">
        <option value="letters">Harf</option>
        <option value="words">Soâ€˜zlar</option>
      </select>

      <span id="cat-label" class="label-big" style="display:none;">Mavzu:</span>
      <select id="category" class="big-select" style="display:none;"></select>
    </div>

    <div class="right">
      <span class="label-big">Ovoz:</span>
      <select id="voice-list" class="big-select" title="Arabcha ovozni tanlang">
        <option>â€” yuklanyapti â€”</option>
      </select>
      <button id="btn-voices-refresh" class="btn secondary" title="Ovozlarni qayta yuklash">ğŸ” Ovozlarni yangilash</button>
      <button id="btn-tts" class="btn secondary" title="Ovozni yoqish/oâ€˜chirish">ğŸ”Š Yoqilgan</button>
      <button id="btn-shuffle" class="btn">ğŸ”€ Aralashtirish</button>
      <button id="btn-reset"   class="btn secondary">â†©ï¸ Qaytarish</button>
      <button id="btn-dark"    class="btn secondary">ğŸŒ— Dark</button>
    </div>
  </div>

  <main>
    <section id="grid" class="grid" aria-live="polite"></section>
  </main>

  <!-- Overlay -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <button id="ov-close" class="ov-close" aria-label="Yopish">Ã—</button>
    <div class="nav"><button id="prev" aria-label="Oldingi">â€¹</button><button id="next" aria-label="Keyingi">â€º</button></div>
    <div class="ttsbar">
      <button id="tts-play" class="btn warn" title="Tinglash">ğŸ”Š Tinglash</button>
      <button id="tts-stop" class="btn secondary" title="Toâ€˜xtatish">â¹ï¸ Stop</button>
    </div>
  </div>

<script>
/* ======== Harflar (faqat arabcha nom koâ€˜rsatiladi) ======== */
const LETTERS = [
  L("Ø§","Ø£Ù„Ù"), L("Ø¨","Ø¨Ø§Ø¡"), L("Øª","ØªØ§Ø¡"), L("Ø«","Ø«Ø§Ø¡"),
  L("Ø¬","Ø¬ÙŠÙ…"), L("Ø­","Ø­Ø§Ø¡"), L("Ø®","Ø®Ø§Ø¡"), L("Ø¯","Ø¯Ø§Ù„"),
  L("Ø°","Ø°Ø§Ù„"), L("Ø±","Ø±Ø§Ø¡"), L("Ø²","Ø²Ø§ÙŠ"), L("Ø³","Ø³ÙŠÙ†"),
  L("Ø´","Ø´ÙŠÙ†"), L("Øµ","ØµØ§Ø¯"), L("Ø¶","Ø¶Ø§Ø¯"), L("Ø·","Ø·Ø§Ø¡"),
  L("Ø¸","Ø¸Ø§Ø¡"), L("Ø¹","Ø¹ÙŠÙ†"), L("Øº","ØºÙŠÙ†"), L("Ù","ÙØ§Ø¡"),
  L("Ù‚","Ù‚Ø§Ù"), L("Ùƒ","ÙƒØ§Ù"), L("Ù„","Ù„Ø§Ù…"), L("Ù…","Ù…ÙŠÙ…"),
  L("Ù†","Ù†ÙˆÙ†"), L("Ù‡","Ù‡Ø§Ø¡"), L("Ùˆ","ÙˆØ§Ùˆ"), L("ÙŠ","ÙŠØ§Ø¡"),
];
function L(char, nameAr){ return {char, nameAr}; }

/* ======== Soâ€˜zlar toâ€˜plamlari (namunalar; 50 taga toâ€˜ldiriladi) ======== */
function W(ar, uz){ return {ar, uz}; }
const WORD_SETS = {
  "Hayvonlar":[ W("Ø£ÙØ³ÙØ¯","Sher"),W("Ù‚ÙØ·ÙÙ‘Ø©","Mushuk"),W("ÙƒÙÙ„Ù’Ø¨","It"),W("Ø­ÙØµÙØ§Ù†","Ot"),W("Ù†ÙÙ…ÙØ±","Yoâ€˜lbars"),
    W("ÙÙÙŠÙ„","Fil"),W("Ø²ÙØ±ÙØ§ÙÙØ©","Jirafa"),W("Ù‚ÙØ±Ù’Ø¯","Maymun"),W("Ø«ÙØ¹Ù’Ù„ÙØ¨","Tulki"),W("Ø°ÙØ¦Ù’Ø¨","Boâ€˜ri"),
    W("Ø¯ÙØ¨Ù‘","Ayiq"),W("ØºÙØ²ÙØ§Ù„","Jeyran"),W("Ø¬ÙÙ…ÙÙ„","Tuya"),W("Ø®ÙØ±ÙÙˆÙ","Qoâ€˜y"),W("Ø¨ÙÙ‚ÙØ±ÙØ©","Sigir"),
    W("Ø­ÙÙ…ÙØ§Ù…ÙØ©","Kabutar"),W("Ø¨ÙØ·ÙÙ‘Ø©","Oâ€˜rdak"),W("Ø¥ÙÙˆÙØ²Ù‘","Gâ€˜oz"),W("Ù†ÙØ­Ù’Ù„","Asalari"),W("ÙÙØ±ÙØ§Ø´ÙØ©","Kapalak"),
    W("Ø³ÙÙ…ÙÙƒ","Baliq"),W("Ù‚ÙØ±Ù’Ø´","Akula"),W("Ø¯ÙÙˆÙ„Ù’ÙÙÙŠÙ†","Delfin"),W("Ø­ÙÙˆØª","Kit"),W("Ø³ÙÙ„Ù’Ø­ÙÙØ§Ø©","Toshbaqa")
  ],
  "Mevalar":[ W("ØªÙÙÙÙ‘Ø§Ø­","Olma"),W("Ù…ÙÙˆÙ’Ø²","Banan"),W("Ø¹ÙÙ†ÙØ¨","Uzum"),W("Ø¨ÙØ±Ù’ØªÙÙ‚ÙØ§Ù„","Apelsin"),W("Ù„ÙÙŠÙ’Ù…ÙÙˆÙ†","Limon"),
    W("Ø®ÙÙˆØ®","Shaftoli"),W("Ù…ÙØ´Ù’Ù…ÙØ´","Oâ€˜rik"),W("ÙƒÙØ±ÙØ²","Olcha"),W("ÙÙØ±ÙØ§ÙˆÙÙ„ÙØ©","Qulupnay"),W("Ø±ÙÙ…ÙÙ‘Ø§Ù†","Anor")
  ],
  "Ranglar":[ W("Ø£ÙØ³Ù’ÙˆÙØ¯","Qora"),W("Ø£ÙØ¨Ù’ÙŠÙØ¶","Oq"),W("Ø£ÙØ­Ù’Ù…ÙØ±","Qizil"),W("Ø£ÙØ²Ù’Ø±ÙÙ‚","Koâ€˜k"),W("Ø£ÙØ®Ù’Ø¶ÙØ±","Yashil"),
    W("Ø£ÙØµÙ’ÙÙØ±","Sariq"),W("Ø¨ÙÙ†ÙÙ‘ÙŠÙ‘","Jigarrang"),W("Ø±ÙÙ…ÙØ§Ø¯ÙÙŠÙ‘","Kulrang"),W("Ø¨ÙÙ†ÙÙÙ’Ø³ÙØ¬ÙÙŠÙ‘","Siyohrang"),W("ÙˆÙØ±Ù’Ø¯ÙÙŠÙ‘","Pushti")
  ],
  "Qarindoshlar":[ W("Ø£ÙØ¨","Ota"),W("Ø£ÙÙ…Ù‘","Ona"),W("Ø§ÙØ¨Ù’Ù†","Oâ€˜gâ€˜il"),W("Ø¨ÙÙ†Ù’Øª","Qiz"),W("Ø£ÙØ®","Aka/uka"),
    W("Ø£ÙØ®Ù’Øª","Opa/singil"),W("Ø¬ÙØ¯Ù‘","Bobo"),W("Ø¬ÙØ¯ÙÙ‘Ø©","Buvi"),W("Ø¹ÙÙ…Ù‘","Amaki"),W("Ø®ÙØ§Ù„","Togâ€˜a")
  ],
  "Tana aâ€™zolari":[ W("Ø±ÙØ£Ù’Ø³","Bosh"),W("ÙˆÙØ¬Ù’Ù‡","Yuz"),W("Ø¹ÙÙŠÙ’Ù†","Koâ€˜z"),W("Ø£ÙØ°ÙÙ†","Quloq"),W("Ø£ÙÙ†Ù’Ù","Burun"),
    W("ÙÙÙ…","Ogâ€˜iz"),W("ÙŠÙØ¯","Qoâ€˜l"),W("Ø±ÙØ¬Ù’Ù„","Oyoq"),W("Ù‚ÙÙ„Ù’Ø¨","Yurak"),W("Ø´ÙØ¹Ù’Ø±","Soch")
  ],
  "Sinfxona":[ W("ÙƒÙØªÙØ§Ø¨","Kitob"),W("Ù‚ÙÙ„ÙÙ…","Ruchka"),W("Ø¯ÙÙÙ’ØªÙØ±","Daftar"),W("ÙƒÙØ±Ù’Ø³ÙÙŠÙ‘","Stul"),W("Ø·ÙØ§ÙˆÙÙ„ÙØ©","Stol"),
    W("Ù…ÙØ¹ÙÙ„ÙÙ‘Ù…","Oâ€˜qituvchi"),W("Ø³ÙØ¨ÙÙ‘ÙˆØ±ÙØ©","Doska"),W("Ø·ÙØ¨Ù’Ø´ÙÙˆØ±","Boâ€˜r"),W("Ø­ÙÙ‚ÙÙŠØ¨ÙØ©","Sumka"),W("Ù…ÙÙ‚ÙØµÙ‘","Qaychi")
  ],
  "Transport":[ W("Ø³ÙÙŠÙÙ‘Ø§Ø±ÙØ©","Mashina"),W("Ø¯ÙØ±ÙÙ‘Ø§Ø¬ÙØ©","Velosiped"),W("Ø­ÙØ§ÙÙÙ„ÙØ©","Avtobus"),W("Ù‚ÙØ·ÙØ§Ø±","Poyezd"),W("Ø·ÙØ§Ø¦ÙØ±ÙØ©","Samolyot"),
    W("Ù‚ÙØ§Ø±ÙØ¨","Qayiq"),W("Ø³ÙÙÙÙŠÙ†ÙØ©","Kema"),W("Ù…ÙØªÙ’Ø±ÙÙˆ","Metro"),W("ØªÙÙƒÙ’Ø³ÙÙŠ","Taksi"),W("Ø´ÙØ§Ø­ÙÙ†ÙØ©","Yuk mashina")
  ],
  "Tabiat":[ W("Ø´ÙÙ…Ù’Ø³","Quyosh"),W("Ù‚ÙÙ…ÙØ±","Oy"),W("Ù†ÙØ¬Ù’Ù…ÙØ©","Yulduz"),W("Ø³ÙØ­ÙØ§Ø¨","Bulut"),W("Ù…ÙØ·ÙØ±","Yomgâ€˜ir"),
    W("Ø«ÙÙ„Ù’Ø¬","Qor"),W("Ø±ÙÙŠØ­","Shamol"),W("Ø¨ÙØ­Ù’Ø±","Dengiz"),W("Ù†ÙÙ‡Ù’Ø±","Daryo"),W("ØºÙØ§Ø¨ÙØ©","Oâ€˜rmon")
  ],
  "Taomlar":[ W("Ø®ÙØ¨Ù’Ø²","Non"),W("Ù…ÙØ§Ø¡","Suv"),W("Ø­ÙÙ„ÙÙŠØ¨","Sut"),W("Ø£ÙØ±ÙØ²Ù‘","Guruch"),W("Ù„ÙØ­Ù’Ù…","Goâ€˜sht"),
    W("Ø¯ÙØ¬ÙØ§Ø¬","Tovuq"),W("Ø³ÙÙ…ÙÙƒ","Baliq"),W("Ø­ÙØ³ÙØ§Ø¡","Shoâ€˜rva"),W("Ø¬ÙØ¨Ù’Ù†","Pishloq"),W("Ø´ÙØ§ÙŠ","Choy")
  ]
};
function ensureFifty(arr){
  const out = arr.slice(); let i=0;
  while(out.length<50 && arr.length){ const b=arr[i%arr.length]; out.push({ar:b.ar, uz:b.uz+" (takror)"}); i++; }
  return out.slice(0,50);
}

/* ======== DOM ======== */
const grid = document.getElementById('grid');
const overlay = document.getElementById('overlay');
const ovClose = document.getElementById('ov-close');
const btnPrev = document.getElementById('prev');
const btnNext = document.getElementById('next');
const ttsPlay = document.getElementById('tts-play');
const ttsStop = document.getElementById('tts-stop');

const modeSel = document.getElementById('mode');
const catSel  = document.getElementById('category');
const catLabel= document.getElementById('cat-label');

const btnShuffle = document.getElementById('btn-shuffle');
const btnReset   = document.getElementById('btn-reset');
const btnDark    = document.getElementById('btn-dark');

const voiceList  = document.getElementById('voice-list');
const btnVoiceRefresh = document.getElementById('btn-voices-refresh');
const btnTtsToggle = document.getElementById('btn-tts');

let order=[], currentIndex=0, currentCards=[];
const slots = new WeakMap();
let animating=false;

/* ======== TTS (arabcha ovoz roâ€˜yxati bilan) ======== */
const TTS = {
  enabled:true, voice:null, rate:0.9, pitch:1.0, volume:1,
  getVoices(){
    const all = (window.speechSynthesis?.getVoices?.()||[]);
    // faqat arabcha ovozlar
    return all.filter(v=>/^ar(-|$)/i.test(v.lang) || /arabic/i.test(v.name));
  },
  populateSelect(){
    const voices = this.getVoices();
    voiceList.innerHTML = '';
    if(!voices.length){
      const opt=document.createElement('option');
      opt.textContent = "Arabcha ovoz topilmadi (tizim ovozlari yoâ€˜q)";
      opt.value = "";
      voiceList.appendChild(opt);
      this.voice=null; return;
    }
    voices.forEach((v,i)=>{
      const o=document.createElement('option');
      o.value=String(i);
      o.textContent = `${v.name} â€” ${v.lang}`;
      voiceList.appendChild(o);
    });
    // tanlovni saqlash yoki 1-ovozni tanlash
    voiceList.selectedIndex = Math.max(0, voiceList.selectedIndex);
    this.voice = voices[voiceList.selectedIndex] || voices[0];
  },
  pickFromSelect(){
    const voices = this.getVoices();
    const idx = Number(voiceList.value);
    this.voice = voices[idx] || voices[0] || null;
  },
  speak(text){
    if(!this.enabled || !window.speechSynthesis) return;
    this.pickFromSelect();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = (this.voice?.lang) || 'ar-SA';
    if(this.voice) u.voice = this.voice;
    u.rate=this.rate; u.pitch=this.pitch; u.volume=this.volume;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  },
  stop(){ if(window.speechSynthesis) window.speechSynthesis.cancel(); }
};
// iOS/Safariâ€™da ovozlar kech yuklanadi
if('speechSynthesis' in window){
  speechSynthesis.onvoiceschanged = ()=> TTS.populateSelect();
}

/* ======== Boshlash ======== */
initWordsUI(); setMode('letters'); TTS.populateSelect();

/* ======== UI events ======== */
modeSel.addEventListener('change', ()=> setMode(modeSel.value));
catSel.addEventListener('change', ()=> render());
btnShuffle.addEventListener('click', ()=>{ order = shuffle(order); render(false); });
btnReset.addEventListener('click', ()=>{ order = [...Array(currentCards.length).keys()]; render(false); });

btnPrev.addEventListener('click', ()=> swapDelta(-1));
btnNext.addEventListener('click', ()=> swapDelta(+1));
overlay.addEventListener('click', e=>{ if(e.target===overlay) closeLarge(); });
ovClose.addEventListener('click', closeLarge);
window.addEventListener('keydown', e=>{
  if(e.key==='Escape') closeLarge();
  if(!overlay.classList.contains('open')) return;
  if(e.key==='ArrowLeft')  swapDelta(-1);
  if(e.key==='ArrowRight') swapDelta(+1);
});

btnDark.addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  btnDark.textContent = document.body.classList.contains('dark') ? 'ğŸŒ– Light' : 'ğŸŒ— Dark';
});

btnTtsToggle.addEventListener('click', ()=>{
  TTS.enabled = !TTS.enabled;
  btnTtsToggle.textContent = TTS.enabled ? 'ğŸ”Š Yoqilgan' : 'ğŸ”‡ Oâ€˜chirilgan';
  if(!TTS.enabled) TTS.stop();
});
btnVoiceRefresh.addEventListener('click', ()=> TTS.populateSelect());
voiceList.addEventListener('change', ()=> TTS.pickFromSelect());
ttsPlay.addEventListener('click', ()=> speakCurrent());
ttsStop.addEventListener('click', ()=> TTS.stop());

/* ======== Render va karta boshqaruvlari ======== */
function initWordsUI(){
  catSel.innerHTML='';
  Object.keys(WORD_SETS).forEach(k=>{
    const o=document.createElement('option'); o.value=k; o.textContent=k; catSel.appendChild(o);
  });
}
function setMode(mode){
  closeLarge(true);
  if(mode==='letters'){
    catSel.style.display='none'; catLabel.style.display='none';
    currentCards = LETTERS.map(x=>({type:'letter', char:x.char, nameAr:x.nameAr}));
  }else{
    catSel.style.display='inline-block'; catLabel.style.display='inline-block';
    const cat = catSel.value || Object.keys(WORD_SETS)[0];
    currentCards = ensureFifty(WORD_SETS[cat]).map(x=>({type:'word', ...x}));
  }
  order = [...Array(currentCards.length).keys()];
  render(true);
}
function render(resetOverlay=true){
  if(resetOverlay) closeLarge(true);
  grid.innerHTML='';
  order.forEach((idx)=>{
    const d = currentCards[idx];
    const card = el('div','card');
    const btn  = el('button','card-btn'); btn.type='button';
    btn.setAttribute('aria-label', d.type==='letter' ? `Harf ${d.char}` : `Soâ€˜z ${d.ar}`);
    const inner= el('div','inner');

    const front= el('div','face front');
    const txt  = el('div', d.type==='letter' ? 'letter':'word'); txt.textContent = d.type==='letter'? d.char : d.ar;
    front.appendChild(txt);

    const back = el('div','face back');
    const info = el('div','info');
    const big  = el('p','big'); big.textContent = d.type==='letter'? getLetterName(d.char) : d.ar;
    const name = el('p','name'); if(d.type==='word'){ name.textContent = d.uz; }
    info.appendChild(big); if(name.textContent) info.appendChild(name); back.appendChild(info);

    inner.appendChild(front); inner.appendChild(back); btn.appendChild(inner); card.appendChild(btn); grid.appendChild(card);

    btn.addEventListener('click', ()=> openOrSwap(card, order.indexOf(idx)));
  });
}
function getLetterName(ch){ const it=LETTERS.find(x=>x.char===ch); return it?it.nameAr:ch; }

/* ======== Placeholder ======== */
function el(t,c){const n=document.createElement(t); if(c) n.className=c; return n;}
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

function createPlaceholder(fromCard){
  const ph=el('div','placeholder'); const h=fromCard.getBoundingClientRect().height||parseFloat(getComputedStyle(fromCard).height);
  ph.style.height=(h||parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-h')))+'px'; return ph;
}
function parkCardWithPlaceholder(card){
  const parent=card.parentNode, next=card.nextSibling; const ph=createPlaceholder(card);
  parent.insertBefore(ph,next); slots.set(card,{parent,next,placeholder:ph});
}
function restoreCardFromPlaceholder(card){
  const s=slots.get(card); if(!s) return; const {parent,next,placeholder}=s;
  if(placeholder&&placeholder.parentNode){ parent.insertBefore(card,placeholder); placeholder.remove(); } else { parent.insertBefore(card,next||null); }
  slots.delete(card);
}

/* ======== Open/Swap/Close ======== */
function openOrSwap(card,i){ if(animating) return; overlay.classList.contains('open') ? swapTo(i,card) : openLarge(card,i); }
function openLarge(card,i){
  if(animating) return; currentIndex=i; parkCardWithPlaceholder(card);
  overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false');
  card.classList.add('is-open','is-large','pop-in'); overlay.appendChild(card);
  document.body.style.overflow='hidden';
  speakCurrent();
}
function closeLarge(immediate=false){
  if(!overlay.classList.contains('open')) return; const card=overlay.querySelector('.card'); if(!card){ overlay.classList.remove('open'); return; }
  if(immediate){ card.classList.remove('is-open','is-large','pop-in','pop-out'); restoreCardFromPlaceholder(card); overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; TTS.stop(); return; }
  if(animating) return; animating=true; TTS.stop();
  card.classList.remove('pop-in'); card.classList.add('pop-out');
  card.addEventListener('animationend', function h(){ card.removeEventListener('animationend',h);
    card.classList.remove('is-open','is-large','pop-out'); restoreCardFromPlaceholder(card);
    overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; animating=false;
  });
}
function swapDelta(delta){
  if(!overlay.classList.contains('open')) return;
  const nextIndex=(currentIndex+delta+order.length)%order.length; const target=grid.children[nextIndex]; if(target) swapTo(nextIndex,target);
}
function swapTo(newIndex,newCard){
  if(animating) return; animating=true; const oldCard=overlay.querySelector('.card'); TTS.stop();
  if(oldCard){
    oldCard.classList.remove('pop-in'); oldCard.classList.add('pop-out');
    oldCard.addEventListener('animationend', function onOut(){
      oldCard.removeEventListener('animationend',onOut);
      oldCard.classList.remove('is-open','is-large','pop-out'); restoreCardFromPlaceholder(oldCard);
      currentIndex=newIndex; parkCardWithPlaceholder(newCard);
      newCard.classList.add('is-open','is-large','pop-in'); overlay.appendChild(newCard);
      newCard.addEventListener('animationend', function onIn(){ newCard.removeEventListener('animationend',onIn); animating=false; speakCurrent(); });
    });
  }else{ openLarge(newCard,newIndex); animating=false; }
}

/* ======== TTS helper ======== */
function speakCurrent(){
  if(!TTS.enabled) return;
  const item = currentCards[currentIndex]; if(!item) return;
  const text = (item.type==='letter') ? getLetterName(item.char) : item.ar;
  TTS.speak(text);
}
</script>
</body>
</html>