<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arab Alifbosi ‚Äî Kartochkalar + So‚Äòzlar</title>
<style>
:root{
  --bg:#f4f8ff; --panel:#eaf2ff; --card:#ffffff; --ink:#16324a;
  --accent:#ffd166; --btn:#0aa2ff; --btn-ink:#fff;
  --card-h:180px; /* kartochka balandligi va placeholder uchun */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Noto Kufi Arabic",Arial,sans-serif;
  background:var(--bg); color:var(--ink);
}

/* ---------- Top ---------- */
.topbar{ text-align:center; padding:18px 12px; background:var(--panel); border-bottom:1px solid #dbe7ff; }
.topbar h1{margin:0 0 6px; font-size:clamp(18px, 3vw, 28px)}
.hint{margin:6px 0 0; color:#325c84; font-weight:600}

.toolbar{
  max-width:1100px; margin:10px auto 0; padding:0 16px;
  display:flex; gap:8px; justify-content:space-between; align-items:center; flex-wrap:wrap;
}
.left, .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.btn{
  background:var(--btn); color:var(--btn-ink); border:none; border-radius:10px; padding:8px 12px; cursor:pointer;
  font-weight:700; box-shadow:0 6px 16px rgba(10,162,255,.25);
}
.btn.secondary{ background:#e9f4ff; color:#0a3760; box-shadow:none; border:1px solid #cfe3ff; }
.btn.warn{ background:#ffd166; color:#4a2a00; box-shadow:0 6px 16px rgba(255,209,102,.25); }
.btn:active{transform:translateY(1px)}
select{
  padding:8px 10px; border-radius:10px; border:1px solid #cfe3ff; background:#fff;
}

/* ---------- Grid (RTL) ---------- */
.grid{
  --min:130px;
  display:grid; gap:18px; padding:18px; margin:0 auto 28px;
  grid-template-columns:repeat(auto-fill, minmax(var(--min), 1fr));
  max-width:1100px;
  direction: rtl; /* o‚Äòngdan chapga terish */
}
/* Kartochka ichida LTR, arabcha matnni alohida RTL qilamiz */
.card, .card * { direction: ltr; }

/* Placeholder ‚Äî karta o‚Äòrnini ushlab turadi */
.placeholder{
  height:var(--card-h);
  border-radius:18px;
  visibility:hidden;  /* joyni egallaydi, ko‚Äòrinmaydi */
}

/* ---------- Card (flip) ---------- */
.card{ perspective:1000px; height:var(--card-h); }
.card-btn{ position:relative; width:100%; height:100%; border:0; background:transparent; padding:0; cursor:pointer; }
.inner{
  position:absolute; inset:0; border-radius:18px; background:var(--card);
  box-shadow:0 12px 32px rgba(0,0,0,.08);
  transition: transform .5s cubic-bezier(.2,.7,.2,1), box-shadow .2s;
  transform-style: preserve-3d;
  border:1px solid #dfe8f5;
}
.card-btn:hover .inner{ box-shadow:0 14px 40px rgba(0,0,0,.12) }
.card.is-open .inner{ transform: rotateY(180deg); }

.face{ position:absolute; inset:0; backface-visibility:hidden; border-radius:18px; display:flex; align-items:center; justify-content:center; padding:14px; }
.front{ background: radial-gradient(circle at 30% -10%, #eaf3ff, #eaf3ff 30%, #ffffff 30%); }
.letter, .word{
  font-family:"Noto Kufi Arabic","Amiri",serif;
  font-size: clamp(34px, 7.6vw, 48px);
  line-height:1.1; color:#0a2450;
  text-shadow: 0 2px 0 #fff, 0 10px 24px rgba(10,36,80,.18);
  text-align:center;
}
.back{
  transform: rotateY(180deg);
  background:
    linear-gradient(135deg, #fff7e6, #fff),
    radial-gradient(120px 80px at 100% 0%, #ffe39b, transparent 70%),
    radial-gradient(100px 60px at 0% 100%, #cfe9ff, transparent 70%);
}
.info{ text-align:center; }
.info .big{
  font-family:"Noto Kufi Arabic","Amiri",serif; margin:0 0 6px; direction:rtl;
  font-size:40px;
}
.info .name{ margin:2px 0 10px; font-weight:800; color:#274a70; font-size:20px; }
.badge{display:inline-block; padding:4px 10px; border-radius:999px; background:#eef5ff; border:1px dashed #bcd6f7; color:#0a3a66; font-weight:700}

/* rangli frontlar */
.card:nth-child(6n+1) .front{background: radial-gradient(circle at 30% -10%, #e3f7ff, #e3f7ff 30%, #fff 30%);}
.card:nth-child(6n+2) .front{background: radial-gradient(circle at 70% -10%, #ffe9f3, #ffe9f3 30%, #fff 30%);}
.card:nth-child(6n+3) .front{background: radial-gradient(circle at 20% -10%, #fff3d9, #fff3d9 30%, #fff 30%);}
.card:nth-child(6n+4) .front{background: radial-gradient(circle at 70% -10%, #ecffe9, #ecffe9 30% , #fff 30%);}
.card:nth-child(6n+5) .front{background: radial-gradient(circle at 30% -10%, #f1e9ff, #f1e9ff 30%, #fff 30%);}
.card:nth-child(6n+6) .front{background: radial-gradient(circle at 70% -10%, #ffe9e9, #ffe9e9 30%, #fff 30%);}

/* ---------- Overlay (modal) ‚Äî blur+zoom fon + animatsiya ---------- */
.overlay{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  background: rgba(2,15,31,0.0);
  backdrop-filter: blur(0px) scale(1);
  z-index:50; padding:18px;
  direction: rtl;
  opacity:0; pointer-events:none;
  transition: background .35s ease, backdrop-filter .35s ease, opacity .35s ease;
}
.overlay.open{
  background: rgba(2,15,31,0.55);
  backdrop-filter: blur(3px) scale(1.02);
  opacity:1; pointer-events:auto;
}
.ov-close{
  position:absolute; left:14px; top:12px; z-index:60;
  border:none; background:var(--accent); color:#4a2a00;
  width:38px; height:38px; border-radius:50%; cursor:pointer; font-size:24px; font-weight:900;
  box-shadow:0 8px 22px rgba(0,0,0,.25);
}
.nav{
  position:absolute; inset-inline:16px; top:50%; transform:translateY(-50%);
  display:flex; justify-content:space-between; pointer-events:none;
}
.nav button{
  pointer-events:auto; width:44px; height:44px; border-radius:50%; border:none;
  background:#ffffffcc; color:#0a2b52; font-size:22px; cursor:pointer; box-shadow:0 10px 22px rgba(0,0,0,.2);
}

/* Katta karta o‚Äòlchamlari */
.card.is-large{ width:min(92vw, 460px); height:min(80vh, 520px); }

/* Ochilish/yopilish animatsiyalari */
.card.pop-in{ transform: scale(0.7) translateY(30px); opacity:0; animation: popIn .45s cubic-bezier(.25,.8,.25,1) forwards; }
.card.pop-out{ transform: scale(1) translateY(0); opacity:1; animation: popOut .35s cubic-bezier(.4,.0,.2,1) forwards; }
@keyframes popIn{
  0%{ transform:scale(0.7) translateY(30px); opacity:0; }
  60%{ transform:scale(1.05) translateY(-6px); opacity:1; }
  100%{ transform:scale(1) translateY(0); opacity:1; }
}
@keyframes popOut{
  0%{ transform:scale(1) translateY(0); opacity:1; }
  100%{ transform:scale(0.7) translateY(40px); opacity:0; }
}

/* Katta rejimda matn o‚Äòlchami */
.card.is-large .letter{ font-size: clamp(72px, 14vw, 110px); }
.card.is-large .info .big{ font-size: clamp(48px, 8vw, 80px); }
.card.is-large .info .name{ font-size: clamp(22px, 3.6vw, 32px); }

/* ---------- Dark Mode ---------- */
.dark{
  --bg:#0e1726; --panel:#0b1423; --card:#101a2b; --ink:#dbe8ff; --btn:#3aaefc; --btn-ink:#05233b;
}
.dark .topbar{border-bottom-color:#10213a}
.dark .inner{border-color:#1a2a44; box-shadow:0 8px 24px rgba(0,0,0,.5)}
.dark .front{background: radial-gradient(circle at 30% -10%, #152338, #152338 30%, #0f1b2d 30%);}
.dark .ov-close{background:#ffc95b}
.dark .btn.secondary{background:#0f2139;color:#dbe8ff;border-color:#1d3b63}
</style>
</head>
<body>
  <header class="topbar">
    <h1>Arab Alifbosi ‚Äî Kartochkalar</h1>
    <p class="hint">Kartochkaga bosing ‚Äî kattalashadi va o‚Äòqilishi ko‚Äòrinadi</p>
  </header>

  <div class="toolbar">
    <div class="left">
      <label for="mode">Rejim:</label>
      <select id="mode">
        <option value="letters">Harf</option>
        <option value="words">So‚Äòzlar</option>
      </select>

      <label for="category" id="cat-label" style="display:none;">Mavzu:</label>
      <select id="category" style="display:none;"></select>
    </div>

    <div class="right">
      <button id="btn-shuffle" class="btn">üîÄ Aralashtirish</button>
      <button id="btn-reset"   class="btn secondary">‚Ü©Ô∏è Qaytarish</button>
      <button id="btn-quiz"    class="btn warn">üß† Quiz</button>
      <button id="btn-dark"    class="btn secondary">üåó Dark</button>
    </div>
  </div>

  <main>
    <section id="grid" class="grid" aria-live="polite"></section>
  </main>

  <!-- Overlay (kattalashgan karta) -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <button id="ov-close" class="ov-close" aria-label="Yopish">√ó</button>
    <div class="nav">
      <button id="prev" aria-label="Oldingi">‚Äπ</button>
      <button id="next" aria-label="Keyingi">‚Ä∫</button>
    </div>
  </div>

  <!-- Quiz modal (overlaydan foydalanamiz) -->
  <template id="quiz-tpl">
    <div class="quiz">
      <style>
        .quiz-wrap{background:var(--card);border-radius:18px;padding:18px;max-width:560px;width:min(92vw,560px);
                   box-shadow:0 18px 40px rgba(0,0,0,.25);border:1px solid #dfe8f5;text-align:center}
        .quiz .harf{font-family:"Noto Kufi Arabic","Amiri",serif;font-size:80px;margin:0 0 10px}
        .quiz .opts{display:grid;gap:10px;margin-top:6px}
        .quiz .opts button{padding:10px 12px;border-radius:12px;border:1px solid #cfe3ff;cursor:pointer;background:#eaf4ff;font-weight:700}
        .quiz .opts button.good{background:#d9f9d9;border-color:#7fce7f}
        .quiz .opts button.bad{background:#ffd6d6;border-color:#f28b8b}
        .quiz .foot{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
        .quiz .score{font-weight:800}
      </style>
      <div class="quiz-wrap">
        <div class="harf" id="q-char"></div>
        <div class="opts" id="q-opts"></div>
        <div class="foot">
          <div class="score" id="q-score">0/0</div>
          <button class="btn" id="q-next">Keyingi</button>
        </div>
      </div>
    </div>
  </template>

<script>
/* =================== MA'LUMOTLAR =================== */
const LETTERS = [
  L("ÿß","Alif","ÿ£ŸÑŸÅ"), L("ÿ®","Bo","ÿ®ÿßÿ°"), L("ÿ™","To","ÿ™ÿßÿ°"), L("ÿ´","Sa","ÿ´ÿßÿ°"),
  L("ÿ¨","Jim","ÿ¨ŸäŸÖ"), L("ÿ≠","Ho","ÿ≠ÿßÿ°"), L("ÿÆ","Xo","ÿÆÿßÿ°"), L("ÿØ","Dal","ÿØÿßŸÑ"),
  L("ÿ∞","Zal","ÿ∞ÿßŸÑ"), L("ÿ±","Ro","ÿ±ÿßÿ°"), L("ÿ≤","Zo","ÿ≤ÿßŸä"), L("ÿ≥","Sin","ÿ≥ŸäŸÜ"),
  L("ÿ¥","Shin","ÿ¥ŸäŸÜ"), L("ÿµ","Sod","ÿµÿßÿØ"), L("ÿ∂","Dod","ÿ∂ÿßÿØ"), L("ÿ∑","To‚Äò","ÿ∑ÿßÿ°"),
  L("ÿ∏","Zo‚Äò","ÿ∏ÿßÿ°"), L("ÿπ","Ayn","ÿπŸäŸÜ"), L("ÿ∫","G‚Äòayn","ÿ∫ŸäŸÜ"), L("ŸÅ","Fo","ŸÅÿßÿ°"),
  L("ŸÇ","Qof","ŸÇÿßŸÅ"), L("ŸÉ","Kaf","ŸÉÿßŸÅ"), L("ŸÑ","Lam","ŸÑÿßŸÖ"), L("ŸÖ","Mim","ŸÖŸäŸÖ"),
  L("ŸÜ","Nun","ŸÜŸàŸÜ"), L("Ÿá","Ha","Ÿáÿßÿ°"), L("Ÿà","Vav","ŸàÿßŸà"), L("Ÿä","Ya","Ÿäÿßÿ°"),
];
function L(char, uz, ar){ return {char, uz, ar}; }

const WORD_SETS = {
  "Hayvonlar": [
    W("ÿ£Ÿéÿ≥ŸéÿØ","Sher"), W("ŸÇŸêÿ∑ŸéŸëÿ©","Mushuk"), W("ŸÉŸéŸÑŸíÿ®","It"), W("ÿ≠ŸêÿµŸéÿßŸÜ","Ot"), 
    W("ÿ∑Ÿéÿßÿ¶Ÿêÿ±","Qush"), W("ÿ≥ŸéŸÖŸéŸÉ","Baliq")
  ],
  "Mevalar": [
    W("ÿ™ŸèŸÅŸéŸëÿßÿ≠","Olma"), W("ŸÖŸéŸàŸíÿ≤","Banan"), W("ÿπŸêŸÜŸéÿ®","Uzum"), W("ÿ®Ÿèÿ±Ÿíÿ™ŸèŸÇŸéÿßŸÑ","Apelsin"),
    W("ŸÑŸéŸäŸíŸÖŸèŸàŸÜ","Limon"), W("ŸÅŸêÿ±ŸéÿßŸàŸêŸÑŸéÿ©","Qulupnay")
  ],
  "Ranglar": [
    W("ÿ£Ÿéÿ≠ŸíŸÖŸéÿ±","Qizil"), W("ÿ£Ÿéÿ≤Ÿíÿ±ŸéŸÇ","Ko‚Äòk"), W("ÿ£ŸéÿÆŸíÿ∂Ÿéÿ±","Yashil"), W("ÿ£ŸéÿµŸíŸÅŸéÿ±","Sariq"),
    W("ÿ£Ÿéÿ≥ŸíŸàŸéÿØ","Qora"), W("ÿ£Ÿéÿ®ŸíŸäŸéÿ∂","Oq"), W("ÿ®ŸèŸÜŸêŸëŸäŸë","Jigarrang"),
    W("ÿ®ŸéŸÜŸéŸÅŸíÿ≥Ÿéÿ¨ŸêŸäŸë","Siyohrang"), W("ÿ®Ÿèÿ±Ÿíÿ™ŸèŸÇŸéÿßŸÑŸêŸäŸë","To‚Äòq sariq"), W("ŸàŸéÿ±ŸíÿØŸêŸäŸë","Pushti")
  ],
  "Qarindoshlar": [
    W("ÿ£Ÿéÿ®","Ota"), W("ÿ£ŸèŸÖŸë","Ona"), W("ÿ£ŸéÿÆ","Aka/uka"), W("ÿ£ŸèÿÆŸíÿ™","Opa/singil"), 
    W("ÿ¨ŸéÿØŸë","Bobo"), W("ÿ¨ŸéÿØŸéŸëÿ©","Buvi"), W("ÿπŸéŸÖŸë","Amaki"), W("ÿπŸéŸÖŸéŸëÿ©","Amma"),
    W("ÿÆŸéÿßŸÑ","Tog‚Äòa"), W("ÿÆŸéÿßŸÑŸéÿ©","Xola")
  ],
  "Tana a‚Äôzolari": [
    W("ÿ±Ÿéÿ£Ÿíÿ≥","Bosh"), W("ŸàŸéÿ¨ŸíŸá","Yuz"), W("ÿπŸéŸäŸíŸÜ","Ko‚Äòz"), W("ÿ£Ÿèÿ∞ŸèŸÜ","Quloq"),
    W("ŸÅŸéŸÖ","Og‚Äòiz"), W("ÿ£ŸéŸÜŸíŸÅ","Burun"), W("ŸäŸéÿØ","Qo‚Äòl"), W("ÿ±Ÿêÿ¨ŸíŸÑ","Oyoq"),
    W("ŸÇŸéŸÑŸíÿ®","Yurak"), W("ÿ¥ŸéÿπŸíÿ±","Soch")
  ],
  "Sinfxona": [
    W("ŸÉŸêÿ™Ÿéÿßÿ®","Kitob"), W("ŸÇŸéŸÑŸéŸÖ","Ruchka"), W("ÿØŸéŸÅŸíÿ™Ÿéÿ±","Daftar"), W("ŸÉŸèÿ±Ÿíÿ≥ŸêŸäŸë","Stul"),
    W("ÿ∑ŸéÿßŸàŸêŸÑŸéÿ©","Stol"), W("ŸÖŸèÿπŸéŸÑŸêŸëŸÖ","O‚Äòqituvchi")
  ],
  "Transport": [
    W("ÿ≥ŸéŸäŸéŸëÿßÿ±Ÿéÿ©","Mashina"), W("ÿØŸéÿ±ŸéŸëÿßÿ¨Ÿéÿ©","Velosiped"), W("ÿ≠ŸéÿßŸÅŸêŸÑŸéÿ©","Avtobus"),
    W("ŸÇŸêÿ∑Ÿéÿßÿ±","Poyezd"), W("ÿ∑Ÿéÿßÿ¶Ÿêÿ±Ÿéÿ©","Samolyot"), W("ŸÇŸéÿßÿ±Ÿêÿ®","Qayiq")
  ],
  "Tabiat": [
    W("ÿ¥ŸéŸÖŸíÿ≥","Quyosh"), W("ŸÇŸéŸÖŸéÿ±","Oy"), W("ŸÜŸéÿ¨ŸíŸÖŸéÿ©","Yulduz"), W("ÿ¥Ÿéÿ¨Ÿéÿ±Ÿéÿ©","Daraxt"),
    W("ÿ≤ŸéŸáŸíÿ±Ÿéÿ©","Gul"), W("ÿ®Ÿéÿ≠Ÿíÿ±","Dengiz")
  ],
  "Taomlar": [
    W("ÿÆŸèÿ®Ÿíÿ≤","Non"), W("ŸÖŸéÿßÿ°","Suv"), W("ÿ≠ŸéŸÑŸêŸäÿ®","Sut"), W("ÿ£Ÿéÿ±Ÿèÿ≤Ÿë","Guruch"),
    W("ŸÑŸéÿ≠ŸíŸÖ","Go‚Äòsht"), W("ÿ¨Ÿèÿ®ŸíŸÜ","Pishloq")
  ]
};
function W(ar, uz){ return {ar, uz}; }

/* =================== DOM & HOLAT =================== */
const grid      = document.getElementById('grid');
const overlay   = document.getElementById('overlay');
const ovClose   = document.getElementById('ov-close');
const btnPrev   = document.getElementById('prev');
const btnNext   = document.getElementById('next');

const modeSel   = document.getElementById('mode');
const catSel    = document.getElementById('category');
const catLabel  = document.getElementById('cat-label');

const btnShuffle= document.getElementById('btn-shuffle');
const btnReset  = document.getElementById('btn-reset');
const btnQuiz   = document.getElementById('btn-quiz');
const btnDark   = document.getElementById('btn-dark');

const quizTpl   = document.getElementById('quiz-tpl');

let order = [];
let currentIndex = 0;
let currentCards = [];
const slots = new WeakMap(); // card -> {parent, next, placeholder}
let animating = false;

const el = (t,c)=>{const n=document.createElement(t); if(c) n.className=c; return n;};
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

/* ====== Boshlang‚Äòich holat ====== */
initWordsUI();
setMode('letters');

/* ====== UI eventlar ====== */
modeSel.addEventListener('change', ()=> setMode(modeSel.value));
catSel.addEventListener('change', ()=> render());

btnShuffle.addEventListener('click', ()=>{ order = shuffle(order); render(false); });
btnReset.addEventListener('click', ()=>{ order = [...Array(currentCards.length).keys()]; render(false); });

btnPrev.addEventListener('click', ()=> swapDelta(-1));
btnNext.addEventListener('click', ()=> swapDelta(+1));
overlay.addEventListener('click', e=>{ if(e.target===overlay) closeLarge(); });
ovClose.addEventListener('click', closeLarge);
window.addEventListener('keydown', e=>{
  if(e.key==='Escape') closeLarge();
  if(!overlay.classList.contains('open')) return;
  if(e.key==='ArrowLeft')  swapDelta(-1);
  if(e.key==='ArrowRight') swapDelta(+1);
});

btnQuiz.addEventListener('click', startQuiz);
btnDark.addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  btnDark.textContent = document.body.classList.contains('dark') ? 'üåñ Light' : 'üåó Dark';
});

/* =================== FUNKSIYALAR =================== */
function setMode(mode){
  closeLarge(true); // darhol qaytarib qo‚Äòyish (placeholder ham tozalanadi)
  if(mode==='letters'){
    catSel.style.display='none'; catLabel.style.display='none';
    currentCards = LETTERS.map(x=>({type:'letter', ...x}));
  }else{
    catSel.style.display='inline-block'; catLabel.style.display='inline-block';
    const cat = catSel.value || Object.keys(WORD_SETS)[0];
    currentCards = WORD_SETS[cat].map(x=>({type:'word', ...x}));
  }
  order = [...Array(currentCards.length).keys()];
  render(true);
}
function initWordsUI(){
  catSel.innerHTML = '';
  Object.keys(WORD_SETS).forEach(k=>{
    const o=document.createElement('option'); o.value=k; o.textContent=k; catSel.appendChild(o);
  });
}
function render(resetOverlay=true){
  if(resetOverlay) closeLarge(true);
  grid.innerHTML='';
  order.forEach((idx)=>{
    const d = currentCards[idx];
    const card=el('div','card');
    const btn=el('button','card-btn'); btn.type='button'; btn.setAttribute('aria-label', ariaLabel(d));
    const inner=el('div','inner');

    const front=el('div','face front');
    const txt=el('div', d.type==='letter' ? 'letter' : 'word');
    txt.textContent = d.type==='letter' ? d.char : d.ar;
    front.appendChild(txt);

    const back=el('div','face back');
    const info=el('div','info');
    const big=el('p','big'); big.textContent = d.ar;
    const name=el('p','name'); name.textContent= d.uz;
    if(d.type==='word'){
      const badge=el('span','badge'); badge.textContent='So‚Äòz';
      info.appendChild(badge);
    }
    info.appendChild(big); info.appendChild(name);
    back.appendChild(info);

    inner.appendChild(front); inner.appendChild(back);
    btn.appendChild(inner); card.appendChild(btn); grid.appendChild(card);

    btn.addEventListener('click', ()=> openOrSwap(card, order.indexOf(idx)));
  });
}
function ariaLabel(d){
  return d.type==='letter' ? `Harf ${d.char}, ${d.uz}` : `So‚Äòz ${d.ar}, ${d.uz}`;
}

/* ---- Placeholder yordamchilari ---- */
function createPlaceholder(fromCard){
  const ph = el('div','placeholder');
  // real o‚Äòlchamni olib, balandlikni moslaymiz
  const h = fromCard.getBoundingClientRect().height || parseFloat(getComputedStyle(fromCard).height);
  ph.style.height = (h||parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-h'))) + 'px';
  return ph;
}
function parkCardWithPlaceholder(card){
  // card o‚Äòrniga placeholder qo‚Äòyib, card‚Äôni overlayga ko‚Äòchiramiz
  const parent = card.parentNode;
  const next   = card.nextSibling;
  const ph = createPlaceholder(card);
  parent.insertBefore(ph, next); // carddan oldin turgan joyga qo‚Äòyiladi (card overlayga ketadi)
  slots.set(card, {parent, next, placeholder: ph});
  return {parent, next, placeholder: ph};
}
function restoreCardFromPlaceholder(card){
  const s = slots.get(card);
  if(!s) return;
  const {parent, next, placeholder} = s;
  if(placeholder && placeholder.parentNode){
    parent.insertBefore(card, placeholder);
    placeholder.remove();
  } else {
    parent.insertBefore(card, next || null);
  }
  slots.delete(card);
}

/* ---- Katta karta boshqaruvlari ---- */
function openOrSwap(card, i){
  if(animating) return;
  if(overlay.classList.contains('open')){
    swapTo(i, card);
  }else{
    openLarge(card, i);
  }
}
function openLarge(card, i){
  if(animating) return;
  currentIndex = i;

  // o‚Äòringa placeholder qoldirib, kartani overlayga ko‚Äòchiramiz
  parkCardWithPlaceholder(card);

  overlay.classList.add('open');
  overlay.setAttribute('aria-hidden','false');

  card.classList.add('is-open','is-large','pop-in');
  overlay.appendChild(card);

  document.body.style.overflow='hidden';
}
function closeLarge(immediate=false){
  if(!overlay.classList.contains('open')) return;
  const card = overlay.querySelector('.card');
  if(!card){ overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; return; }

  if(immediate){
    card.classList.remove('is-open','is-large','pop-in','pop-out');
    restoreCardFromPlaceholder(card);
    overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); document.body.style.overflow='';
    return;
  }

  if(animating) return;
  animating = true;
  card.classList.remove('pop-in'); card.classList.add('pop-out');
  card.addEventListener('animationend', function handler(){
    card.removeEventListener('animationend', handler);
    card.classList.remove('is-open','is-large','pop-out');
    restoreCardFromPlaceholder(card);
    overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true');
    document.body.style.overflow='';
    animating = false;
  });
}

/* ---- Swap: eski karta yopilib, yangi karta ochiladi ---- */
function swapDelta(delta){
  if(!overlay.classList.contains('open')) return;
  const nextIndex = (currentIndex + delta + order.length) % order.length;
  const target = grid.querySelectorAll('.card, .placeholder')[nextIndex*1] // gridda placeholder ham bor
    ? findCardAtGridIndex(nextIndex)
    : grid.children[nextIndex];
  if(target) swapTo(nextIndex, target);
}
function findCardAtGridIndex(index){
  // gridda placeholderlar bo‚Äòlishi mumkin; shu indeksdagi asl kartani topamiz
  let seen=-1;
  for(const node of grid.childNodes){
    if(!(node instanceof HTMLElement)) continue;
    if(!node.classList.contains('card') && !node.classList.contains('placeholder')) continue;
    seen++;
    if(seen===index){
      // agar placeholder bo‚Äòlsa, uning yonidagi asl card overlayda bo‚Äòlishi mumkin
      if(node.classList.contains('card')) return node;
      // placeholderga mos keluvchi card overlayda
      const overlayCard = overlay.querySelector('.card');
      return overlayCard || null;
    }
  }
  return null;
}
function swapTo(newIndex, newCard){
  if(animating) return;
  animating = true;

  const oldCard = overlay.querySelector('.card');

  // 1) Eski kartani animatsiya bilan yopamiz va joyiga qaytaramiz
  if(oldCard){
    oldCard.classList.remove('pop-in');
    oldCard.classList.add('pop-out');
    oldCard.addEventListener('animationend', function onOut(){
      oldCard.removeEventListener('animationend', onOut);
      oldCard.classList.remove('is-open','is-large','pop-out');
      restoreCardFromPlaceholder(oldCard);

      // 2) Yangi karta uchun placeholder yaratib, overlayga olib kelamiz
      currentIndex = newIndex;
      parkCardWithPlaceholder(newCard);
      newCard.classList.add('is-open','is-large','pop-in');
      overlay.appendChild(newCard);

      newCard.addEventListener('animationend', function onIn(){
        newCard.removeEventListener('animationend', onIn);
        animating = false;
      });
    });
  }else{
    // Eski karta yo‚Äòq ‚Äî oddiy ochish
    openLarge(newCard, newIndex);
    animating = false;
  }
}

/* ---- Quiz ---- */
function startQuiz(){
  if(animating) return;
  closeLarge(true);
  overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false');
  document.body.style.overflow='hidden';

  const frag = quizTpl.content.cloneNode(true);
  const wrap = frag.querySelector('.quiz-wrap');
  overlay.appendChild(wrap);

  let score=0, total=0;
  nextQ();

  function pool(){
    if(modeSel.value==='letters') return LETTERS.map(x=>({q:x.char, a:x.uz}));
    const items = getCurrentWordSet();
    return items.map(x=>({q:x.ar, a:x.uz}));
  }
  function getCurrentWordSet(){
    const cat = catSel.value || Object.keys(WORD_SETS)[0];
    return WORD_SETS[cat];
  }
  function nextQ(){
    const P = pool();
    const it = P[Math.floor(Math.random()*P.length)];
    const opts = new Set([it.a]);
    while(opts.size<4){ opts.add(P[Math.floor(Math.random()*P.length)].a); }
    const mix = Array.from(opts); shuffle(mix);

    wrap.querySelector('#q-char').textContent = it.q;
    const box = wrap.querySelector('#q-opts'); box.innerHTML='';
    mix.forEach(name=>{
      const b=document.createElement('button'); b.textContent=name;
      b.addEventListener('click', ()=>{
        total++;
        if(name===it.a){ score++; b.classList.add('good'); } else { b.classList.add('bad'); }
        wrap.querySelectorAll('#q-opts button').forEach(x=>x.disabled=true);
        upd();
      });
      box.appendChild(b);
    });
    wrap.querySelector('#q-next').onclick = nextQ;
    upd();
  }
  function upd(){ wrap.querySelector('#q-score').textContent = `${score}/${total}`; }

  // yopish
  overlay.addEventListener('click', onOv, {once:true});
  window.addEventListener('keydown', onEsc);
  function onOv(e){ if(e.target===overlay){ end(); } else { overlay.addEventListener('click', onOv, {once:true}); } }
  function onEsc(e){ if(e.key==='Escape'){ end(); } }
  function end(){
    overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true');
    document.body.style.overflow=''; wrap.remove(); window.removeEventListener('keydown', onEsc);
  }
}

/* ====== UI yordamchilari ====== */
function openLargeFromGridEl(cardEl){
  const idx = [...grid.children].indexOf(cardEl);
  if(idx>=0) openOrSwap(cardEl, idx);
}
function getCurrentCards(){
  return (modeSel.value==='letters')
    ? LETTERS.map(x=>({type:'letter', ...x}))
    : (WORD_SETS[catSel.value || Object.keys(WORD_SETS)[0]].map(x=>({type:'word', ...x})));
}
</script>
</body>
</html>