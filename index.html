<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arab Alifbosi â€” TTS, Ota-ona nazorati, Oâ€˜yinlar, Streak</title>
<style>
:root{
  --bg:#f4f8ff; --panel:#eaf2ff; --card:#ffffff; --ink:#16324a;
  --accent:#ffd166; --btn:#0aa2ff; --btn-ink:#fff; --card-h:180px;
  --ok:#26c281; --bad:#ff6b6b; --muted:#5d7a99;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Noto Kufi Arabic",Arial,sans-serif;background:var(--bg);color:var(--ink)}
.topbar{ text-align:center; padding:18px 12px; background:var(--panel); border-bottom:1px solid #dbe7ff; }
.topbar h1{margin:0 0 6px; font-size:clamp(18px, 3vw, 28px)}
.hint{margin:6px 0 0; color:#325c84; font-weight:600}

/* Toolbar */
.toolbar{max-width:1200px;margin:10px auto 0;padding:0 16px;display:flex;gap:12px;justify-content:space-between;align-items:center;flex-wrap:wrap}
.left,.right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{background:var(--btn);color:var(--btn-ink);border:none;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700;box-shadow:0 6px 16px rgba(10,162,255,.25)}
.btn.secondary{background:#e9f4ff;color:#0a3760;box-shadow:none;border:1px solid #cfe3ff}
.btn.warn{background:#ffd166;color:#4a2a00;box-shadow:0 6px 16px rgba(255,209,102,.25)}
.btn.ghost{background:transparent;color:#0a3760;border:1px dashed #cfe3ff}
.btn:active{transform:translateY(1px)}
.big-select{font-size:18px;padding:12px 14px;border-radius:14px}
.label-big{font-size:16px;font-weight:800}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#eef6ff;border:1px solid #cfe3ff;font-weight:800}
.range{display:flex;align-items:center;gap:8px}
.range input[type=range]{width:160px}
.kpi{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.kpi .pill{border:1px solid #cfe3ff;background:#f6fbff;border-radius:999px;padding:6px 10px;font-weight:800}
.kpi .pill .ok{color:var(--ok)} .kpi .pill .muted{color:var(--muted)}

/* Grid (RTL) */
.grid{--min:130px;display:grid;gap:18px;padding:18px;margin:0 auto 28px;grid-template-columns:repeat(auto-fill,minmax(var(--min),1fr));max-width:1200px;direction:rtl}
.card,.card *{direction:ltr}
.placeholder{height:var(--card-h);border-radius:18px;visibility:hidden}

/* Card */
.card{perspective:1000px;height:var(--card-h)}
.card-btn{position:relative;width:100%;height:100%;border:0;background:transparent;padding:0;cursor:pointer}
.inner{position:absolute;inset:0;border-radius:18px;background:var(--card);box-shadow:0 12px 32px rgba(0,0,0,.08);transition:transform .5s cubic-bezier(.2,.7,.2,1),box-shadow .2s;transform-style:preserve-3d;border:1px solid #dfe8f5}
.card-btn:hover .inner{box-shadow:0 14px 40px rgba(0,0,0,.12)}
.card.is-open .inner{transform:rotateY(180deg)}
.face{position:absolute;inset:0;backface-visibility:hidden;border-radius:18px;display:flex;align-items:center;justify-content:center;padding:14px}
.front{background:radial-gradient(circle at 30% -10%,#eaf3ff,#eaf3ff 30%,#fff 30%)}
.letter,.word{font-family:"Noto Kufi Arabic","Amiri",serif;font-size:clamp(34px,7.6vw,48px);line-height:1.1;color:#0a2450;text-shadow:0 2px 0 #fff,0 10px 24px rgba(10,36,80,.18);text-align:center}
.back{transform:rotateY(180deg);background:linear-gradient(135deg,#fff7e6,#fff),radial-gradient(120px 80px at 100% 0%,#ffe39b,transparent 70%),radial-gradient(100px 60px at 0% 100%,#cfe9ff,transparent 70%)}
.info{text-align:center}
.info .big{font-family:"Noto Kufi Arabic","Amiri",serif;margin:0 0 6px;direction:rtl;font-size:40px}
.info .name{margin:2px 0 10px;font-weight:800;color:#274a70;font-size:20px}

/* rangli front */
.card:nth-child(6n+1) .front{background:radial-gradient(circle at 30% -10%,#e3f7ff,#e3f7ff 30%,#fff 30%)}
.card:nth-child(6n+2) .front{background:radial-gradient(circle at 70% -10%,#ffe9f3,#ffe9f3 30%,#fff 30%)}
.card:nth-child(6n+3) .front{background:radial-gradient(circle at 20% -10%,#fff3d9,#fff3d9 30%,#fff 30%)}
.card:nth-child(6n+4) .front{background:radial-gradient(circle at 70% -10%,#ecffe9,#ecffe9 30%,#fff 30%)}
.card:nth-child(6n+5) .front{background:radial-gradient(circle at 30% -10%,#f1e9ff,#f1e9ff 30%,#fff 30%)}
.card:nth-child(6n+6) .front{background:radial-gradient(circle at 70% -10%,#ffe9e9,#ffe9e9 30%,#fff 30%)}

/* Overlay */
.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,15,31,0);backdrop-filter:blur(0px) scale(1);z-index:50;padding:18px;direction:rtl;opacity:0;pointer-events:none;transition:background .35s ease,backdrop-filter .35s ease,opacity .35s ease}
.overlay.open{background:rgba(2,15,31,.55);backdrop-filter:blur(3px) scale(1.02);opacity:1;pointer-events:auto}
.ov-close{position:absolute;left:14px;top:12px;z-index:60;border:none;background:var(--accent);color:#4a2a00;width:38px;height:38px;border-radius:50%;cursor:pointer;font-size:24px;font-weight:900;box-shadow:0 8px 22px rgba(0,0,0,.25)}
.nav{position:absolute;inset-inline:16px;top:50%;transform:translateY(-50%);display:flex;justify-content:space-between;pointer-events:none}
.nav button{pointer-events:auto;width:44px;height:44px;border-radius:50%;border:none;background:#ffffffcc;color:#0a2b52;font-size:22px;cursor:pointer;box-shadow:0 10px 22px rgba(0,0,0,.2)}
.ttsbar{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:60}
.ov-actions{position:absolute;top:12px;right:14px;display:flex;gap:8px;z-index:70}

/* Animations */
.card.is-large{width:min(92vw,460px);height:min(80vh,520px)}
.card.pop-in{transform:scale(.7) translateY(30px);opacity:0;animation:popIn .45s cubic-bezier(.25,.8,.25,1) forwards}
.card.pop-out{transform:scale(1) translateY(0);opacity:1;animation:popOut .35s cubic-bezier(.4,0,.2,1) forwards}
@keyframes popIn{0%{transform:scale(.7) translateY(30px);opacity:0}60%{transform:scale(1.05) translateY(-6px);opacity:1}100%{transform:scale(1) translateY(0);opacity:1}}
@keyframes popOut{0%{transform:scale(1) translateY(0);opacity:1}100%{transform:scale(.7) translateY(40px);opacity:0}}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}

/* Score & streak */
.kpi .pill .star{color:#f0b429}
.streak{display:flex;align-items:center;gap:6px}
.progress{position:relative; width:160px; height:10px; background:#e8f1ff; border-radius:999px; overflow:hidden}
.progress > i{position:absolute;left:0;top:0;bottom:0;background:#0aa2ff;border-radius:999px}

/* Stats modal */
.stats{background:var(--card);border-radius:16px;padding:18px;max-width:640px;width:min(92vw,640px);box-shadow:0 18px 40px rgba(0,0,0,.25);border:1px solid #dfe8f5}
.stats h3{margin:0 0 10px}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
.tile{border:1px solid #e4edff;border-radius:12px;padding:10px;background:#fbfdff}
.chart{display:flex;gap:6px;align-items:flex-end;height:100px}
.chart div{flex:1;background:#b9d9ff;border-radius:6px 6px 0 0;position:relative}
.chart div i{position:absolute;bottom:100%;left:50%;transform:translate(-50%,-4px);font-size:12px;color:#345}
.chart div small{position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-size:11px;color:#567}

/* Game state hints */
.target{outline:3px dashed #0a8dff; outline-offset:4px; animation:pulse 1s infinite}
.wrong{animation:shake .3s}

/* Dark */
.dark{--bg:#0e1726;--panel:#0b1423;--card:#101a2b;--ink:#dbe8ff;--btn:#3aaefc;--btn-ink:#05233b}
.dark .topbar{border-bottom-color:#10213a}
.dark .inner{border-color:#1a2a44;box-shadow:0 8px 24px rgba(0,0,0,.5)}
.dark .front{background:radial-gradient(circle at 30% -10%,#152338,#152338 30%,#0f1b2d 30%)}
.dark .ov-close{background:#ffc95b}
.dark .btn.secondary{background:#0f2139;color:#dbe8ff;border-color:#1d3b63}
</style>
</head>
<body>
  <header class="topbar">
    <h1>Arab Alifbosi â€” Kartochkalar</h1>
    <p class="hint">Kartochkaga bosing â€” kattalashadi va oâ€˜qilishi koâ€˜rinadi</p>
  </header>

  <div class="toolbar">
    <div class="left">
      <span class="label-big">Rejim:</span>
      <select id="mode" class="big-select">
        <option value="letters">Harf</option>
        <option value="words">Soâ€˜zlar</option>
      </select>

      <span id="cat-label" class="label-big" style="display:none;">Mavzu:</span>
      <select id="category" class="big-select" style="display:none;"></select>

      <button id="btn-favs-toggle" class="btn ghost" title="Sevimlilarni koâ€˜rsat/yashirish">â¤ï¸ Sevimlilar</button>
    </div>

    <div class="right" id="controls">
      <div class="kpi">
        <div class="pill"><span class="muted">ğŸ¯ Maqsad:</span> <b id="goal">30</b>/kun</div>
        <div class="pill"><span class="muted">ğŸ“ˆ Bugun:</span> <b id="todayCount">0</b></div>
        <div class="pill streak"><span class="muted">ğŸ”¥ Streak:</span> <b id="streak">0</b></div>
        <div class="progress" title="Kunlik maqsad">
          <i id="goalBar" style="width:0%"></i>
        </div>
      </div>

      <span class="label-big">Ovoz tezligi:</span>
      <div class="range">
        <span>0.5Ã—</span>
        <input id="rate" type="range" min="0.5" max="1.5" step="0.1" value="0.9" />
        <span id="rateVal">0.9Ã—</span>
      </div>

      <button id="btn-tts" class="btn secondary" title="Ovozni yoqish/oâ€˜chirish">ğŸ”Š Yoqilgan</button>
      <button id="btn-game" class="btn warn" title="Harfni top oâ€˜yini">ğŸ¯ Harf oâ€˜yini</button>
      <button id="btn-picgame" class="btn warn" title="Soâ€˜z â†’ rasm oâ€˜yini">ğŸ–¼ï¸ Soâ€˜z-rasm</button>
      <button id="btn-shuffle" class="btn">ğŸ”€ Aralashtirish</button>
      <button id="btn-reset"   class="btn secondary">â†©ï¸ Qaytarish</button>
      <button id="btn-dark"    class="btn secondary">ğŸŒ— Dark</button>

      <div class="badge" title="Umumiy ball">
        ğŸ§® <span class="score" id="score">0</span>
        <span class="stars" id="stars"></span>
      </div>
    </div>

    <div class="right">
      <button id="btn-parent" class="btn" title="Otaâ€‘ona nazorati">ğŸ”’ Bolalar rejimi</button>
      <button id="btn-stats" class="btn secondary" title="Statistika (otaâ€‘ona)">ğŸ“Š Stat</button>
    </div>
  </div>

  <main>
    <section id="grid" class="grid" aria-live="polite"></section>
  </main>

  <!-- Overlay -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <button id="ov-close" class="ov-close" aria-label="Yopish">Ã—</button>
    <div class="nav"><button id="prev" aria-label="Oldingi">â€¹</button><button id="next" aria-label="Keyingi">â€º</button></div>

    <div class="ov-actions">
      <button id="btn-fav" class="btn secondary" title="Sevimlilarga qoâ€˜shish">â¤ï¸ Sevimli</button>
      <button id="btn-speakback" class="btn secondary" title="Eshit va takrorla">ğŸ¤ Takrorla</button>
    </div>

    <div class="ttsbar">
      <button id="tts-play" class="btn warn" title="Tinglash">ğŸ”Š Tinglash</button>
      <button id="tts-stop" class="btn secondary" title="Toâ€˜xtatish">â¹ï¸ Stop</button>
    </div>
  </div>

<script>
/* =================== Ma'lumotlar =================== */
const LETTERS = [
  L("Ø§","Ø£Ù„Ù"), L("Ø¨","Ø¨Ø§Ø¡"), L("Øª","ØªØ§Ø¡"), L("Ø«","Ø«Ø§Ø¡"),
  L("Ø¬","Ø¬ÙŠÙ…"), L("Ø­","Ø­Ø§Ø¡"), L("Ø®","Ø®Ø§Ø¡"), L("Ø¯","Ø¯Ø§Ù„"),
  L("Ø°","Ø°Ø§Ù„"), L("Ø±","Ø±Ø§Ø¡"), L("Ø²","Ø²Ø§ÙŠ"), L("Ø³","Ø³ÙŠÙ†"),
  L("Ø´","Ø´ÙŠÙ†"), L("Øµ","ØµØ§Ø¯"), L("Ø¶","Ø¶Ø§Ø¯"), L("Ø·","Ø·Ø§Ø¡"),
  L("Ø¸","Ø¸Ø§Ø¡"), L("Ø¹","Ø¹ÙŠÙ†"), L("Øº","ØºÙŠÙ†"), L("Ù","ÙØ§Ø¡"),
  L("Ù‚","Ù‚Ø§Ù"), L("Ùƒ","ÙƒØ§Ù"), L("Ù„","Ù„Ø§Ù…"), L("Ù…","Ù…ÙŠÙ…"),
  L("Ù†","Ù†ÙˆÙ†"), L("Ù‡","Ù‡Ø§Ø¡"), L("Ùˆ","ÙˆØ§Ùˆ"), L("ÙŠ","ÙŠØ§Ø¡"),
];
function L(char, nameAr){ return {char, nameAr}; }

function W(ar, uz){ return {ar, uz}; }
const WORD_SETS = {
  "Hayvonlar":[ W("Ø£ÙØ³ÙØ¯","Sher"),W("Ù‚ÙØ·ÙÙ‘Ø©","Mushuk"),W("ÙƒÙÙ„Ù’Ø¨","It"),W("Ø­ÙØµÙØ§Ù†","Ot"),W("Ù†ÙÙ…ÙØ±","Yoâ€˜lbars"),
    W("ÙÙÙŠÙ„","Fil"),W("Ø²ÙØ±ÙØ§ÙÙØ©","Jirafa"),W("Ù‚ÙØ±Ù’Ø¯","Maymun"),W("Ø«ÙØ¹Ù’Ù„ÙØ¨","Tulki"),W("Ø°ÙØ¦Ù’Ø¨","Boâ€˜ri"),
    W("Ø¯ÙØ¨Ù‘","Ayiq"),W("ØºÙØ²ÙØ§Ù„","Jeyran"),W("Ø¬ÙÙ…ÙÙ„","Tuya"),W("Ø®ÙØ±ÙÙˆÙ","Qoâ€˜y"),W("Ø¨ÙÙ‚ÙØ±ÙØ©","Sigir"),
    W("Ø­ÙÙ…ÙØ§Ù…ÙØ©","Kabutar"),W("Ø¨ÙØ·ÙÙ‘Ø©","Oâ€˜rdak"),W("Ø¥ÙÙˆÙØ²Ù‘","Gâ€˜oz"),W("Ù†ÙØ­Ù’Ù„","Asalari"),W("ÙÙØ±ÙØ§Ø´ÙØ©","Kapalak"),
    W("Ø³ÙÙ…ÙÙƒ","Baliq"),W("Ù‚ÙØ±Ù’Ø´","Akula"),W("Ø¯ÙÙˆÙ„Ù’ÙÙÙŠÙ†","Delfin"),W("Ø­ÙÙˆØª","Kit"),W("Ø³ÙÙ„Ù’Ø­ÙÙØ§Ø©","Toshbaqa")
  ],
  "Mevalar":[ W("ØªÙÙÙÙ‘Ø§Ø­","Olma"),W("Ù…ÙÙˆÙ’Ø²","Banan"),W("Ø¹ÙÙ†ÙØ¨","Uzum"),W("Ø¨ÙØ±Ù’ØªÙÙ‚ÙØ§Ù„","Apelsin"),W("Ù„ÙÙŠÙ’Ù…ÙÙˆÙ†","Limon"),
    W("Ø®ÙÙˆØ®","Shaftoli"),W("Ù…ÙØ´Ù’Ù…ÙØ´","Oâ€˜rik"),W("ÙƒÙØ±ÙØ²","Olcha"),W("ÙÙØ±ÙØ§ÙˆÙÙ„ÙØ©","Qulupnay"),W("Ø±ÙÙ…ÙÙ‘Ø§Ù†","Anor")
  ],
  "Ranglar":[ W("Ø£ÙØ³Ù’ÙˆÙØ¯","Qora"),W("Ø£ÙØ¨Ù’ÙŠÙØ¶","Oq"),W("Ø£ÙØ­Ù’Ù…ÙØ±","Qizil"),W("Ø£ÙØ²Ù’Ø±ÙÙ‚","Koâ€˜k"),W("Ø£ÙØ®Ù’Ø¶ÙØ±","Yashil"),
    W("Ø£ÙØµÙ’ÙÙØ±","Sariq"),W("Ø¨ÙÙ†ÙÙ‘ÙŠÙ‘","Jigarrang"),W("Ø±ÙÙ…ÙØ§Ø¯ÙÙŠÙ‘","Kulrang"),W("Ø¨ÙÙ†ÙÙÙ’Ø³ÙØ¬ÙÙŠÙ‘","Siyohrang"),W("ÙˆÙØ±Ù’Ø¯ÙÙŠÙ‘","Pushti")
  ],
  "Qarindoshlar":[ W("Ø£ÙØ¨","Ota"),W("Ø£ÙÙ…Ù‘","Ona"),W("Ø§ÙØ¨Ù’Ù†","Oâ€˜gâ€˜il"),W("Ø¨ÙÙ†Ù’Øª","Qiz"),W("Ø£ÙØ®","Aka/uka"),
    W("Ø£ÙØ®Ù’Øª","Opa/singil"),W("Ø¬ÙØ¯Ù‘","Bobo"),W("Ø¬ÙØ¯ÙÙ‘Ø©","Buvi"),W("Ø¹ÙÙ…Ù‘","Amaki"),W("Ø®ÙØ§Ù„","Togâ€˜a")
  ],
  "Tana aâ€™zolari":[ W("Ø±ÙØ£Ù’Ø³","Bosh"),W("ÙˆÙØ¬Ù’Ù‡","Yuz"),W("Ø¹ÙÙŠÙ’Ù†","Koâ€˜z"),W("Ø£ÙØ°ÙÙ†","Quloq"),W("Ø£ÙÙ†Ù’Ù","Burun"),
    W("ÙÙÙ…","Ogâ€˜iz"),W("ÙŠÙØ¯","Qoâ€˜l"),W("Ø±ÙØ¬Ù’Ù„","Oyoq"),W("Ù‚ÙÙ„Ù’Ø¨","Yurak"),W("Ø´ÙØ¹Ù’Ø±","Soch")
  ],
  "Sinfxona":[ W("ÙƒÙØªÙØ§Ø¨","Kitob"),W("Ù‚ÙÙ„ÙÙ…","Ruchka"),W("Ø¯ÙÙÙ’ØªÙØ±","Daftar"),W("ÙƒÙØ±Ù’Ø³ÙÙŠÙ‘","Stul"),W("Ø·ÙØ§ÙˆÙÙ„ÙØ©","Stol"),
    W("Ù…ÙØ¹ÙÙ„ÙÙ‘Ù…","Oâ€˜qituvchi"),W("Ø³ÙØ¨ÙÙ‘ÙˆØ±ÙØ©","Doska"),W("Ø·ÙØ¨Ù’Ø´ÙÙˆØ±","Boâ€˜r"),W("Ø­ÙÙ‚ÙÙŠØ¨ÙØ©","Sumka"),W("Ù…ÙÙ‚ÙØµÙ‘","Qaychi")
  ],
  "Transport":[ W("Ø³ÙÙŠÙÙ‘Ø§Ø±ÙØ©","Mashina"),W("Ø¯ÙØ±ÙÙ‘Ø§Ø¬ÙØ©","Velosiped"),W("Ø­ÙØ§ÙÙÙ„ÙØ©","Avtobus"),W("Ù‚ÙØ·ÙØ§Ø±","Poyezd"),W("Ø·ÙØ§Ø¦ÙØ±ÙØ©","Samolyot"),
    W("Ù‚ÙØ§Ø±ÙØ¨","Qayiq"),W("Ø³ÙÙÙÙŠÙ†ÙØ©","Kema"),W("Ù…ÙØªÙ’Ø±ÙÙˆ","Metro"),W("ØªÙÙƒÙ’Ø³ÙÙŠ","Taksi"),W("Ø´ÙØ§Ø­ÙÙ†ÙØ©","Yuk mashina")
  ],
  "Tabiat":[ W("Ø´ÙÙ…Ù’Ø³","Quyosh"),W("Ù‚ÙÙ…ÙØ±","Oy"),W("Ù†ÙØ¬Ù’Ù…ÙØ©","Yulduz"),W("Ø³ÙØ­ÙØ§Ø¨","Bulut"),W("Ù…ÙØ·ÙØ±","Yomgâ€˜ir"),
    W("Ø«ÙÙ„Ù’Ø¬","Qor"),W("Ø±ÙÙŠØ­","Shamol"),W("Ø¨ÙØ­Ù’Ø±","Dengiz"),W("Ù†ÙÙ‡Ù’Ø±","Daryo"),W("ØºÙØ§Ø¨ÙØ©","Oâ€˜rmon")
  ],
  "Taomlar":[ W("Ø®ÙØ¨Ù’Ø²","Non"),W("Ù…ÙØ§Ø¡","Suv"),W("Ø­ÙÙ„ÙÙŠØ¨","Sut"),W("Ø£ÙØ±ÙØ²Ù‘","Guruch"),W("Ù„ÙØ­Ù’Ù…","Goâ€˜sht"),
    W("Ø¯ÙØ¬ÙØ§Ø¬","Tovuq"),W("Ø³ÙÙ…ÙÙƒ","Baliq"),W("Ø­ÙØ³ÙØ§Ø¡","Shoâ€˜rva"),W("Ø¬ÙØ¨Ù’Ù†","Pishloq"),W("Ø´ÙØ§ÙŠ","Choy")
  ]
};
function ensureFifty(arr){
  const out = arr.slice(); let i=0;
  while(out.length<50 && arr.length){ const b=arr[i%arr.length]; out.push({ar:b.ar, uz:b.uz+" (takror)"}); i++; }
  return out.slice(0,50);
}

/* Emoji piktogrammalar (Soâ€˜zâ†’Rasm oâ€˜yini) â€” minimal xarita */
const EMOJI = {
  "Ø£ÙØ³ÙØ¯":"ğŸ¦","Ù‚ÙØ·ÙÙ‘Ø©":"ğŸ±","ÙƒÙÙ„Ù’Ø¨":"ğŸ¶","Ø­ÙØµÙØ§Ù†":"ğŸ´","Ù†ÙÙ…ÙØ±":"ğŸ¯","ÙÙÙŠÙ„":"ğŸ˜","Ø²ÙØ±ÙØ§ÙÙØ©":"ğŸ¦’","Ù‚ÙØ±Ù’Ø¯":"ğŸµ","Ø«ÙØ¹Ù’Ù„ÙØ¨":"ğŸ¦Š","Ø°ÙØ¦Ù’Ø¨":"ğŸº","Ø¯ÙØ¨Ù‘":"ğŸ»","Ø¬ÙÙ…ÙÙ„":"ğŸ«","Ø¨ÙÙ‚ÙØ±ÙØ©":"ğŸ®","Ø®ÙØ±ÙÙˆÙ":"ğŸ‘","Ø³ÙÙ„Ù’Ø­ÙÙØ§Ø©":"ğŸ¢","Ø³ÙÙ…ÙÙƒ":"ğŸŸ","Ø¯ÙÙˆÙ„Ù’ÙÙÙŠÙ†":"ğŸ¬","Ø­ÙÙˆØª":"ğŸ‹","Ù‚ÙØ±Ù’Ø´":"ğŸ¦ˆ",
  "ØªÙÙÙÙ‘Ø§Ø­":"ğŸ","Ù…ÙÙˆÙ’Ø²":"ğŸŒ","Ø¹ÙÙ†ÙØ¨":"ğŸ‡","Ø¨ÙØ±Ù’ØªÙÙ‚ÙØ§Ù„":"ğŸŠ","Ù„ÙÙŠÙ’Ù…ÙÙˆÙ†":"ğŸ‹","Ø®ÙÙˆØ®":"ğŸ‘","Ù…ÙØ´Ù’Ù…ÙØ´":"ğŸ‘","ÙƒÙØ±ÙØ²":"ğŸ’","Ø±ÙÙ…ÙÙ‘Ø§Ù†":"ğŸ«š","ÙÙØ±ÙØ§ÙˆÙÙ„ÙØ©":"ğŸ“",
  "Ø´ÙÙ…Ù’Ø³":"â˜€ï¸","Ù‚ÙÙ…ÙØ±":"ğŸŒ™","Ù†ÙØ¬Ù’Ù…ÙØ©":"â­","Ø³ÙØ­ÙØ§Ø¨":"â˜ï¸","Ù…ÙØ·ÙØ±":"ğŸŒ§ï¸","Ø«ÙÙ„Ù’Ø¬":"â„ï¸","Ø±ÙÙŠØ­":"ğŸŒ¬ï¸","Ø¨ÙØ­Ù’Ø±":"ğŸŒŠ","Ù†ÙÙ‡Ù’Ø±":"ğŸï¸","ØºÙØ§Ø¨ÙØ©":"ğŸŒ²",
  "Ø³ÙÙŠÙÙ‘Ø§Ø±ÙØ©":"ğŸš—","Ø¯ÙØ±ÙÙ‘Ø§Ø¬ÙØ©":"ğŸš²","Ø­ÙØ§ÙÙÙ„ÙØ©":"ğŸšŒ","Ù‚ÙØ·ÙØ§Ø±":"ğŸš†","Ø·ÙØ§Ø¦ÙØ±ÙØ©":"âœˆï¸","Ù‚ÙØ§Ø±ÙØ¨":"ğŸ›¶","Ø³ÙÙÙÙŠÙ†ÙØ©":"ğŸ›³ï¸","Ù…ÙØªÙ’Ø±ÙÙˆ":"ğŸš‡","ØªÙÙƒÙ’Ø³ÙÙŠ":"ğŸš•","Ø´ÙØ§Ø­ÙÙ†ÙØ©":"ğŸšš",
  "Ø®ÙØ¨Ù’Ø²":"ğŸ","Ù…ÙØ§Ø¡":"ğŸ’§","Ø­ÙÙ„ÙÙŠØ¨":"ğŸ¥›","Ø£ÙØ±ÙØ²Ù‘":"ğŸš","Ù„ÙØ­Ù’Ù…":"ğŸ¥©","Ø¯ÙØ¬ÙØ§Ø¬":"ğŸ—","Ø³ÙÙ…ÙÙƒ":"ğŸŸ","Ø­ÙØ³ÙØ§Ø¡":"ğŸ¥£","Ø¬ÙØ¨Ù’Ù†":"ğŸ§€","Ø´ÙØ§ÙŠ":"ğŸµ"
};
function emojiFor(ar){ return EMOJI[ar] || "â“"; }

/* =================== DOM =================== */
const grid = document.getElementById('grid');
const overlay = document.getElementById('overlay');
const ovClose = document.getElementById('ov-close');
const btnPrev = document.getElementById('prev');
const btnNext = document.getElementById('next');
const ttsPlay = document.getElementById('tts-play');
const ttsStop = document.getElementById('tts-stop');
const btnFav = document.getElementById('btn-fav');
const btnSpeakBack = document.getElementById('btn-speakback');

const modeSel = document.getElementById('mode');
const catSel  = document.getElementById('category');
const catLabel= document.getElementById('cat-label');

const btnShuffle = document.getElementById('btn-shuffle');
const btnReset   = document.getElementById('btn-reset');
const btnDark    = document.getElementById('btn-dark');

const btnGame    = document.getElementById('btn-game');
const btnPicGame = document.getElementById('btn-picgame');

const btnTtsToggle = document.getElementById('btn-tts');
const rateInput = document.getElementById('rate');
const rateVal   = document.getElementById('rateVal');

const scoreEl = document.getElementById('score');
const starsEl = document.getElementById('stars');

const btnParent = document.getElementById('btn-parent');
const btnStats  = document.getElementById('btn-stats');
const controls  = document.getElementById('controls');

const btnFavsToggle = document.getElementById('btn-favs-toggle');

const goalEl = document.getElementById('goal');
const todayCountEl = document.getElementById('todayCount');
const streakEl = document.getElementById('streak');
const goalBar = document.getElementById('goalBar');

/* =================== Holat =================== */
let order=[], currentIndex=0, currentCards=[];
const slots = new WeakMap();
let animating=false;
let kidMode = false;
let favOnly = false;

let score = +(localStorage.getItem('score')||0);
let favLetters = new Set(JSON.parse(localStorage.getItem('favLetters')||'[]'));
let favWords   = new Set(JSON.parse(localStorage.getItem('favWords')||'[]'));

const SETTINGS = {
  goal: +(localStorage.getItem('goal')||30),
  todayDate: (localStorage.getItem('todayDate')||null),
  todayCount: +(localStorage.getItem('todayCount')||0),
  streak: +(localStorage.getItem('streak')||0),
  totalSeconds: +(localStorage.getItem('totalSeconds')||0),
};
let sessionStart = Date.now();

/* =================== TTS (faqat erkak ovoz) =================== */
const TTS = {
  enabled:true, voice:null, rate:0.9, pitch:0.95, volume:1,
  maleHints:["Maged","Tariq","Tarik","Omar","Mehdi","Ali","Ahmed","Hassan","Yousef","Yusuf","Ziad","Hamad","Majed","Yasir","Othman","Khalid"],
  getVoices(){
    const all = (window.speechSynthesis?.getVoices?.()||[]);
    return all.filter(v => /^ar(-|$)/i.test(v.lang) || /Arabic/i.test(v.name));
  },
  pickMale(){
    const vs = this.getVoices();
    if(!vs.length){ this.voice=null; return; }
    this.voice = vs.find(v => this.maleHints.some(h=>v.name.toLowerCase().includes(h.toLowerCase())))
              || vs.find(v => /male|man|guy/i.test(v.name))
              || vs[0];
    this.pitch = 0.95;
  },
  speak(text){
    if(!this.enabled || !window.speechSynthesis) return;
    this.pickMale();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = (this.voice?.lang) || 'ar-SA';
    if(this.voice) u.voice = this.voice;
    u.rate=this.rate; u.pitch=this.pitch; u.volume=this.volume;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  },
  stop(){ if(window.speechSynthesis) window.speechSynthesis.cancel(); }
};
if('speechSynthesis' in window){
  speechSynthesis.onvoiceschanged = ()=> TTS.pickMale();
}

/* =================== Speech Recognition (takrorlash) =================== */
const SR = (()=> {
  const SRClass = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SRClass) return null;
  const r = new SRClass();
  r.lang = 'ar-SA';
  r.interimResults = false;
  r.maxAlternatives = 3;
  return r;
})();

/* =================== Boshlash =================== */
initWordsUI(); setMode('letters'); updateScore(0); initGoal(); tickTimer();

/* =================== UI Events =================== */
modeSel.addEventListener('change', ()=> setMode(modeSel.value));
catSel.addEventListener('change', ()=> render());
btnShuffle.addEventListener('click', ()=>{ order = shuffle(order); render(false); });
btnReset.addEventListener('click', ()=>{ order = [...Array(currentCards.length).keys()]; render(false); });
btnPrev.addEventListener('click', ()=> swapDelta(-1));
btnNext.addEventListener('click', ()=> swapDelta(+1));
overlay.addEventListener('click', e=>{ if(e.target===overlay) closeLarge(); });
ovClose.addEventListener('click', closeLarge);
window.addEventListener('keydown', e=>{
  if(e.key==='Escape') closeLarge();
  if(!overlay.classList.contains('open')) return;
  if(e.key==='ArrowLeft')  swapDelta(-1);
  if(e.key==='ArrowRight') swapDelta(+1);
});
btnDark.addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  btnDark.textContent = document.body.classList.contains('dark') ? 'ğŸŒ– Light' : 'ğŸŒ— Dark';
});

btnTtsToggle.addEventListener('click', ()=>{
  TTS.enabled = !TTS.enabled;
  btnTtsToggle.textContent = TTS.enabled ? 'ğŸ”Š Yoqilgan' : 'ğŸ”‡ Oâ€˜chirilgan';
  if(!TTS.enabled) TTS.stop();
});
rateInput.addEventListener('input', ()=>{
  TTS.rate = +rateInput.value;
  rateVal.textContent = rateInput.value + 'Ã—';
});

btnParent.addEventListener('click', toggleParentMode);
btnStats.addEventListener('click', showStats);

btnFav.addEventListener('click', toggleFavorite);
btnFavsToggle.addEventListener('click', ()=>{
  favOnly = !favOnly;
  btnFavsToggle.classList.toggle('warn', favOnly);
  render();
});
btnSpeakBack.addEventListener('click', doSpeakBack);

btnGame.addEventListener('click', toggleGameLetters);
btnPicGame.addEventListener('click', toggleGamePics);

/* =================== Render va karta boshqaruvlari =================== */
function initWordsUI(){
  catSel.innerHTML='';
  Object.keys(WORD_SETS).forEach(k=>{
    const o=document.createElement('option'); o.value=k; o.textContent=k; catSel.appendChild(o);
  });
}
function setMode(mode){
  closeLarge(true);
  if(mode==='letters'){
    catSel.style.display='none'; catLabel.style.display='none';
    currentCards = LETTERS.map(x=>({type:'letter', char:x.char, nameAr:x.nameAr}));
  }else{
    catSel.style.display='inline-block'; catLabel.style.display='inline-block';
    const cat = catSel.value || Object.keys(WORD_SETS)[0];
    currentCards = ensureFifty(WORD_SETS[cat]).map(x=>({type:'word', ...x}));
  }
  order = [...Array(currentCards.length).keys()];
  render(true);
}
function render(resetOverlay=true){
  if(resetOverlay) closeLarge(true);
  grid.innerHTML='';
  let list = order.map(i=>currentCards[i]);

  if(favOnly){
    list = list.filter(item=>{
      if(item.type==='letter') return favLetters.has('L:'+item.char);
      return favWords.has('W:'+item.ar);
    });
    if(!list.length){
      const msg=document.createElement('div');
      msg.style.gridColumn='1/-1'; msg.style.textAlign='center'; msg.style.padding='20px';
      msg.textContent='Sevimlilar boâ€˜sh. â¤ï¸ tugmasi bilan qoâ€˜shing.';
      grid.appendChild(msg);
      return;
    }
  }

  list.forEach((d)=>{
    const card=el('div','card');
    const btn=el('button','card-btn'); btn.type='button';
    btn.setAttribute('aria-label', d.type==='letter' ? `Harf ${d.char}` : `Soâ€˜z ${d.ar}`);
    const inner=el('div','inner');

    const front=el('div','face front');
    const txt=el('div', d.type==='letter' ? 'letter' : 'word');
    txt.textContent = d.type==='letter' ? d.char : d.ar;
    front.appendChild(txt);

    const back=el('div','face back');
    const info=el('div','info');
    const big=el('p','big'); big.textContent = d.type==='letter' ? getLetterName(d.char) : d.ar;
    const name=el('p','name'); if(d.type==='word'){ name.textContent= d.uz; }
    info.appendChild(big); if(name.textContent) info.appendChild(name);
    back.appendChild(info);

    inner.appendChild(front); inner.appendChild(back);
    btn.appendChild(inner); card.appendChild(btn); grid.appendChild(card);

    const absoluteIndex = currentCards.findIndex(x => (x.type===d.type) && ((x.type==='letter' && x.char===d.char) || (x.type==='word' && x.ar===d.ar)));
    btn.addEventListener('click', ()=> openOrSwap(card, absoluteIndex));
  });
}
function getLetterName(ch){ const it=LETTERS.find(x=>x.char===ch); return it?it.nameAr:ch; }

function el(t,c){const n=document.createElement(t); if(c) n.className=c; return n;}
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

/* ---- Placeholder ---- */
function createPlaceholder(fromCard){
  const ph=el('div','placeholder'); const h=fromCard.getBoundingClientRect().height||parseFloat(getComputedStyle(fromCard).height);
  ph.style.height=(h||parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-h')))+'px'; return ph;
}
function parkCardWithPlaceholder(card){
  const parent=card.parentNode, next=card.nextSibling; const ph=createPlaceholder(card);
  parent.insertBefore(ph,next); slots.set(card,{parent,next,placeholder:ph});
}
function restoreCardFromPlaceholder(card){
  const s=slots.get(card); if(!s) return; const {parent,next,placeholder}=s;
  if(placeholder&&placeholder.parentNode){ parent.insertBefore(card,placeholder); placeholder.remove(); } else { parent.insertBefore(card,next||null); }
  slots.delete(card);
}

/* ---- Overlay open/swap/close + scoring + favorites + goal ---- */
function openOrSwap(card,i){
  if(animating) return;
  if(overlay.classList.contains('open')) swapTo(i, card);
  else openLarge(card, i);
}
function openLarge(card,i){
  if(animating) return;
  currentIndex=i; parkCardWithPlaceholder(card);
  overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false');
  card.classList.add('is-open','is-large','pop-in'); overlay.appendChild(card);
  document.body.style.overflow='hidden';
  speakCurrent();

  // Ball & goal
  updateScore(1);
  incToday();

  // Fav holatini yangilash
  updateFavBtn();
}
function closeLarge(immediate=false){
  if(!overlay.classList.contains('open')) return;
  const card=overlay.querySelector('.card'); if(!card){ overlay.classList.remove('open'); return; }
  if(immediate){
    card.classList.remove('is-open','is-large','pop-in','pop-out');
    restoreCardFromPlaceholder(card); overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; TTS.stop(); return;
  }
  if(animating) return; animating=true; TTS.stop();
  card.classList.remove('pop-in'); card.classList.add('pop-out');
  card.addEventListener('animationend', function h(){ card.removeEventListener('animationend',h);
    card.classList.remove('is-open','is-large','pop-out'); restoreCardFromPlaceholder(card);
    overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; animating=false;
  });
}
function swapDelta(delta){
  if(!overlay.classList.contains('open')) return;
  const nextIndex=(currentIndex+delta+order.length)%order.length;
  const targetData = currentCards[nextIndex];
  const target = [...grid.querySelectorAll('.card')].find(c=>{
    const t = extractCardDataFromEl(c);
    return t && ((t.type==='letter' && t.char===targetData.char) || (t.type==='word' && t.ar===targetData.ar));
  });
  if(target) swapTo(nextIndex,target);
}
function swapTo(newIndex,newCard){
  if(animating) return; animating=true; const oldCard=overlay.querySelector('.card'); TTS.stop();
  if(oldCard){
    oldCard.classList.remove('pop-in'); oldCard.classList.add('pop-out');
    oldCard.addEventListener('animationend', function onOut(){
      oldCard.removeEventListener('animationend',onOut);
      oldCard.classList.remove('is-open','is-large','pop-out'); restoreCardFromPlaceholder(oldCard);
      currentIndex=newIndex; parkCardWithPlaceholder(newCard);
      newCard.classList.add('is-open','is-large','pop-in'); overlay.appendChild(newCard);
      newCard.addEventListener('animationend', function onIn(){ newCard.removeEventListener('animationend',onIn); animating=false; speakCurrent(); updateFavBtn(); });
    });
  }else{ openLarge(newCard,newIndex); animating=false; }
}
function extractCardDataFromEl(cardEl){
  const frontText = cardEl.querySelector('.front .letter, .front .word')?.textContent?.trim();
  if(!frontText) return null;
  const isLetter = LETTERS.some(x=>x.char===frontText);
  if(isLetter) return {type:'letter', char:frontText};
  return {type:'word', ar:frontText};
}

/* ---- TTS helpers ---- */
function speakCurrent(){
  if(!TTS.enabled) return;
  const item = currentCards[currentIndex]; if(!item) return;
  const text = (item.type==='letter') ? getLetterName(item.char) : item.ar;
  TTS.speak(text);
}
ttsPlay.addEventListener('click', ()=> speakCurrent());
ttsStop.addEventListener('click', ()=> TTS.stop());

/* ---- Score & Stars ---- */
function updateScore(inc){
  score = Math.max(0, score + (inc||0));
  localStorage.setItem('score', String(score));
  scoreEl.textContent = score;
  const stars = Math.floor(score/10);
  starsEl.innerHTML = Array.from({length:stars},()=>'<span class="star">â˜…</span>').join('');
}

/* ---- Favorites ---- */
function updateFavBtn(){
  const item=currentCards[currentIndex];
  const key = item.type==='letter' ? 'L:'+item.char : 'W:'+item.ar;
  const inFav = item.type==='letter' ? favLetters.has(key) : favWords.has(key);
  btnFav.textContent = inFav ? 'ğŸ’” Olib tashlash' : 'â¤ï¸ Sevimli';
}
function toggleFavorite(){
  const item=currentCards[currentIndex];
  const key = item.type==='letter' ? 'L:'+item.char : 'W:'+item.ar;
  if(item.type==='letter'){
    if(favLetters.has(key)) favLetters.delete(key); else favLetters.add(key);
    localStorage.setItem('favLetters', JSON.stringify([...favLetters]));
  }else{
    if(favWords.has(key)) favWords.delete(key); else favWords.add(key);
    localStorage.setItem('favWords', JSON.stringify([...favWords]));
  }
  updateFavBtn();
}

/* ---- Ota-ona nazorati ---- */
function toggleParentMode(){
  if(!kidMode){
    kidMode = true;
    applyKidMode();
    btnParent.textContent = 'ğŸ”“ Otaâ€‘ona rejimi';
  }else{
    const p = prompt("Otaâ€‘ona paroli (1234):","");
    if(p==='1234'){ kidMode=false; applyKidMode(); btnParent.textContent='ğŸ”’ Bolalar rejimi'; }
    else { alert("Parol notoâ€˜gâ€˜ri."); }
  }
}
function applyKidMode(){
  controls.style.display = kidMode ? 'none' : 'flex';
  btnGame.style.display = kidMode ? 'none' : 'inline-flex';
  btnPicGame.style.display = kidMode ? 'none' : 'inline-flex';
}

/* ---- Kunlik maqsad & streak ---- */
function todayStr(){ const d=new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function initGoal(){
  goalEl.textContent = SETTINGS.goal;
  if(SETTINGS.todayDate !== todayStr()){ // yangi kun
    rollDay();
  }
  updateGoalUI();
}
function rollDay(){
  // streak hisoblash (kecha maqsad bajarilgan boâ€˜lsa va ketma-ket boâ€˜lsa)
  const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
  const ystr = `${yesterday.getFullYear()}-${String(yesterday.getMonth()+1).padStart(2,'0')}-${String(yesterday.getDate()).padStart(2,'0')}`;
  if(SETTINGS.todayDate===ystr && SETTINGS.todayCount>=SETTINGS.goal){ SETTINGS.streak = (SETTINGS.streak||0)+1; }
  else if(SETTINGS.todayDate) { SETTINGS.streak = 0; }

  SETTINGS.todayDate = todayStr();
  SETTINGS.todayCount = 0;
  persistGoal();
}
function incToday(){
  if(SETTINGS.todayDate !== todayStr()) rollDay();
  SETTINGS.todayCount++;
  persistGoal();
  updateGoalUI();
}
function updateGoalUI(){
  todayCountEl.textContent = SETTINGS.todayCount;
  streakEl.textContent = SETTINGS.streak;
  const pct = Math.min(100, Math.round(SETTINGS.todayCount/SETTINGS.goal*100));
  goalBar.style.width = pct + '%';
  if(SETTINGS.todayCount>=SETTINGS.goal && !document.getElementById('goalCongrats')){
    const s=document.createElement('div'); s.id='goalCongrats'; s.className='badge'; s.style.position='fixed'; s.style.right='12px'; s.style.bottom='12px';
    s.textContent='ğŸ‰ Kunlik maqsad bajarildi!'; document.body.appendChild(s); setTimeout(()=>s.remove(), 3000);
  }
}
function persistGoal(){
  localStorage.setItem('todayDate', SETTINGS.todayDate);
  localStorage.setItem('todayCount', SETTINGS.todayCount);
  localStorage.setItem('streak', SETTINGS.streak);
}

/* ---- Statistika modal ---- */
function showStats(){
  const ov=document.createElement('div'); ov.className='overlay open'; ov.style.zIndex=100;
  ov.innerHTML = `
    <div class="stats">
      <h3>ğŸ“Š Statistika</h3>
      <div class="stat-grid">
        <div class="tile"><b>Umumiy ball:</b><div>${score}</div></div>
        <div class="tile"><b>Yulduzlar:</b><div>${Math.floor(score/10)}</div></div>
        <div class="tile"><b>Streak:</b><div>${SETTINGS.streak}</div></div>
        <div class="tile"><b>Bugungi karta:</b><div>${SETTINGS.todayCount}/${SETTINGS.goal}</div></div>
        <div class="tile"><b>Sevimli harflar:</b><div>${favLetters.size}</div></div>
        <div class="tile"><b>Sevimli soâ€˜zlar:</b><div>${favWords.size}</div></div>
        <div class="tile" style="grid-column:1/-1">
          <b>Oxirgi 7 kun:</b>
          <div class="chart" id="chart7"></div>
        </div>
      </div>
      <div style="margin-top:10px;display:flex;justify-content:flex-end">
        <button id="st-close" class="btn">Yopish</button>
      </div>
    </div>`;
  document.body.appendChild(ov);
  // chart ma'lumot (saqlash: dayCounts: {YYYY-MM-DD: count})
  const map = JSON.parse(localStorage.getItem('dayCounts')||'{}');
  // yangilab qoâ€˜yamiz bugungi kunni
  map[todayStr()] = SETTINGS.todayCount;
  localStorage.setItem('dayCounts', JSON.stringify(map));

  const elChart = ov.querySelector('#chart7');
  const days = [...Array(7)].map((_,i)=>{ const d=new Date(); d.setDate(d.getDate()-(6-i)); const s=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; return s; });
  const max = Math.max(SETTINGS.goal, ...days.map(d=>map[d]||0), 1);
  days.forEach(d=>{
    const v = map[d]||0;
    const bar=document.createElement('div'); bar.style.height = (v/max*100)+'%';
    bar.innerHTML = `<i>${v}</i><small>${d.slice(5)}</small>`;
    elChart.appendChild(bar);
  });
  ov.addEventListener('click', e=>{ if(e.target===ov) ov.remove(); });
  ov.querySelector('#st-close').onclick=()=>ov.remove();
}

/* ---- Miniâ€‘oâ€˜yin 1: Harfni top ---- */
let gameLettersOn=false, targetIndex=null;
function toggleGameLetters(){
  if(modeSel.value!=='letters'){ alert("Oâ€˜yin faqat Harf rejimida ishlaydi."); return; }
  gameLettersOn = !gameLettersOn;
  btnGame.textContent = gameLettersOn ? "ğŸ›‘ Harf oâ€˜yinini toâ€˜xtat" : "ğŸ¯ Harf oâ€˜yini";
  clearTargets();
  if(gameLettersOn){ nextTargetLetter(); }
}
function nextTargetLetter(){
  clearTargets();
  targetIndex = Math.floor(Math.random()*currentCards.length);
  const targetData = currentCards[targetIndex];
  const elCard = [...grid.querySelectorAll('.card')].find(c=>{
    const d = extractCardDataFromEl(c);
    return d && d.type==='letter' && d.char===targetData.char;
  });
  if(elCard){ elCard.classList.add('target'); }
  speakText(getLetterName(targetData.char));
}
function clearTargets(){ grid.querySelectorAll('.card.target').forEach(c=>c.classList.remove('target')); }
function speakText(t){ if(!TTS.enabled) return; TTS.speak(t); }
grid.addEventListener('click', (e)=>{
  if(!gameLettersOn) return;
  const cardEl = e.target.closest('.card'); if(!cardEl) return;
  const data = extractCardDataFromEl(cardEl); if(!data || data.type!=='letter') return;
  const isCorrect = (currentCards[targetIndex]?.char === data.char);
  if(isCorrect){
    updateScore(1); incToday(); burst(cardEl); setTimeout(nextTargetLetter, 500);
  }else{ cardEl.classList.add('wrong'); setTimeout(()=>cardEl.classList.remove('wrong'), 300); }
});

/* ---- Miniâ€‘oâ€˜yin 2: Soâ€˜z â†’ rasm (emoji) ---- */
let gamePicsOn=false;
function toggleGamePics(){
  if(modeSel.value!=='words'){ alert("Bu oâ€˜yin Soâ€˜zlar rejimida ishlaydi."); return; }
  gamePicsOn = !gamePicsOn;
  btnPicGame.textContent = gamePicsOn ? "ğŸ›‘ Soâ€˜z-rasmni toâ€˜xtat" : "ğŸ–¼ï¸ Soâ€˜z-rasm";
  if(gamePicsOn){ startPicRound(); }
}
function startPicRound(){
  if(!gamePicsOn) return;
  const pool = ensureFifty(WORD_SETS[catSel.value || Object.keys(WORD_SETS)[0]]);
  const correct = pool[Math.floor(Math.random()*pool.length)];
  const opts = new Set([correct]);
  while(opts.size<4){ opts.add(pool[Math.floor(Math.random()*pool.length)]); }
  const options = [...opts].sort(()=>Math.random()-0.5);

  const ov=document.createElement('div'); ov.className='overlay open'; ov.style.zIndex=90;
  const htmlOpts = options.map((o,i)=>`<button data-i="${i}" class="btn" style="font-size:38px">${emojiFor(o.ar)}</button>`).join('');
  ov.innerHTML = `
    <div class="stats">
      <h3 style="text-align:center;margin-top:0">ğŸ–¼ï¸ Qaysi rasm? <div style="font-family:'Noto Kufi Arabic','Amiri',serif;direction:rtl;font-size:40px">${correct.ar}</div></h3>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;justify-items:center">${htmlOpts}</div>
      <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
        <button id="p-listen" class="btn warn">ğŸ”Š Eshtirish</button>
        <button id="p-close" class="btn secondary">Yopish</button>
      </div>
    </div>`;
  document.body.appendChild(ov);
  ov.addEventListener('click', e=>{ if(e.target===ov){ ov.remove(); gamePicsOn=false; btnPicGame.textContent="ğŸ–¼ï¸ Soâ€˜z-rasm"; } });

  ov.querySelectorAll('button[data-i]').forEach((b,idx)=>{
    b.onclick=()=>{
      const choice = options[idx];
      if(choice.ar===correct.ar){ b.style.background= "#d9f9d9"; updateScore(1); incToday(); setTimeout(()=>{ ov.remove(); startPicRound(); }, 400); }
      else { b.style.background="#ffd6d6"; }
    };
  });
  ov.querySelector('#p-close').onclick=()=>{ ov.remove(); gamePicsOn=false; btnPicGame.textContent="ğŸ–¼ï¸ Soâ€˜z-rasm"; };
  ov.querySelector('#p-listen').onclick=()=> speakText(correct.ar);
}

/* ---- Takrorlash (Speech Recognition) ---- */
function normalizeArabic(s){
  return (s||'')
    .replace(/[\u064B-\u0652]/g,'') // diakritiklarni olib tashla
    .replace(/Ù±/g,'Ø§')
    .replace(/Ù‰/g,'ÙŠ')
    .replace(/Ø©/g,'Ù‡')
    .replace(/\s+/g,'')
    .trim();
}
function doSpeakBack(){
  if(!SR){ alert("Brauzer nutqni tanishni qoâ€˜llab-quvvatlamaydi."); return; }
  const item = currentCards[currentIndex]; if(!item) return;
  const target = (item.type==='letter') ? getLetterName(item.char) : item.ar;
  TTS.speak("Ø£ÙØ¹ÙØ¯Ù’ Ù…ÙÙ†Ù’ ÙÙØ¶Ù’Ù„ÙÙƒÙ"); // â€œIltimos, takrorlangâ€
  try{
    SR.onresult = (e)=>{
      let best = ''; for(const res of e.results){ best = res[0].transcript; break; }
      const good = normalizeArabic(best) === normalizeArabic(target);
      alert(good ? "âœ… AÊ¼lo! Juda oâ€˜xshash aytdingiz." : ("âŒ Qayta urinib koâ€˜ring.\nSiz: "+best));
    };
    SR.onerror = ()=> alert("âŒ Tinglashda xatolik. Qayta urinib koâ€˜ring.");
    SR.start();
  }catch(err){ alert("âŒ Mikrofon ruxsati kerak boâ€˜lishi mumkin."); }
}

/* ---- Kichik konfet (yulduz) effekti ---- */
function burst(anchor){
  const rect = anchor.getBoundingClientRect();
  for(let i=0;i<10;i++){
    const s=document.createElement('span');
    s.textContent='â˜…'; s.style.position='fixed'; s.style.left=(rect.left+rect.width/2)+'px';
    s.style.top =(rect.top +rect.height/2)+'px';
    s.style.color='#f0b429'; s.style.fontSize=(12+Math.random()*8)+'px';
    s.style.pointerEvents='none'; s.style.transition='transform .8s ease, opacity .8s ease';
    document.body.appendChild(s);
    const dx=(Math.random()-0.5)*160, dy=(Math.random()-0.5)*160;
    requestAnimationFrame(()=>{ s.style.transform=`translate(${dx}px, ${dy}px) scale(1.2)`; s.style.opacity='0'; });
    setTimeout(()=>s.remove(), 850);
  }
}

/* ---- Sessiya va vaqt hisoblagichi ---- */
function tickTimer(){
  setInterval(()=> {
    const now=Date.now(); const delta=Math.floor((now-sessionStart)/1000); sessionStart=now;
    SETTINGS.totalSeconds += delta;
    localStorage.setItem('totalSeconds', SETTINGS.totalSeconds);
  }, 5000);
}

/* =================== Yordamchi =================== */
function openLargeFromGridEl(cardEl){
  const idx = [...grid.children].indexOf(cardEl);
  if(idx>=0) openOrSwap(cardEl, idx);
}
</script>
</body>
</html>